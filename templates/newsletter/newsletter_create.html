{% extends "base.html" %}
{% load static %}

{% block title %}Create Newsletter | XManager{% endblock %}

{% block page_title %}Create Newsletter{% endblock %}

{% block page_actions %}
    <a href="{% url 'newsletter:newsletter_list' %}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-1"></i> Back to Newsletters
    </a>
{% endblock %}

{% block content %}
    <div class="card">
        <div class="card-body">
            <form method="post" id="newsletter-form">
                {% csrf_token %}
                
                {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                        {% for error in form.non_field_errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                {% endif %}
                
                <!-- Content Section -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <h5 class="mb-3">Newsletter Content</h5>
                        
                        <!-- Subject -->
                        <div class="mb-3">
                            <label for="{{ form.subject.id_for_label }}" class="form-label">Subject *</label>
                            {{ form.subject }}
                            {% if form.subject.errors %}
                                <div class="invalid-feedback d-block">{{ form.subject.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <!-- Template -->
                        <div class="mb-3">
                            <label for="{{ form.template.id_for_label }}" class="form-label">Template</label>
                            <select id="{{ form.template.id_for_label }}" name="{{ form.template.html_name }}" class="form-select">
                                <option value="">Default Template</option>
                                {% for template in templates %}
                                    <option value="{{ template.id }}">{{ template.name }}</option>
                                {% endfor %}
                            </select>
                            {% if form.template.errors %}
                                <div class="invalid-feedback d-block">{{ form.template.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <!-- Content -->
                        <div class="mb-3">
                            <label for="{{ form.content.id_for_label }}" class="form-label">Content *</label>
                            {{ form.content }}
                            {% if form.content.errors %}
                                <div class="invalid-feedback d-block">{{ form.content.errors.0 }}</div>
                            {% endif %}
                            <div class="form-text">You can use Markdown or HTML in the content.</div>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-4">
                    <!-- Recipients Options -->
                    <div class="col-md-8">
                        <div class="card h-100">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Recipients</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <!-- Left side: Groups list -->
                                    <div class="col-md-5">
                                        <div class="mb-3">
                                            <label class="form-label">Subscriber Groups</label>
                                            <div class="input-group mb-2">
                                                <input type="text" class="form-control" id="group-search" placeholder="Search groups...">
                                                <button class="btn btn-outline-secondary" type="button" id="clear-group-search">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                            <div class="border rounded p-2" style="height: 300px; overflow-y: auto;">
                                                <div id="groups-list" class="list-group list-group-flush">
                                                    <div class="text-center py-2">
                                                        <div class="spinner-border spinner-border-sm" role="status"></div>
                                                        <span class="ms-2">Loading groups...</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <!-- Hidden input to store selected groups -->
                                            <input type="hidden" id="id_subscriber_groups" name="subscriber_groups">
                                        </div>
                                    </div>
                                    
                                    <!-- Right side: Subscribers from Selected Groups -->
                                    <div class="col-md-7">
                                        <div class="mb-3">
                                            <label class="form-label">Subscribers from Selected Groups</label>
                                            <div class="input-group mb-2">
                                                <input type="text" class="form-control" id="subscriber-search" placeholder="Search subscribers...">
                                                <button class="btn btn-outline-secondary" type="button" id="clear-subscriber-search">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                            <div class="border rounded p-2" style="height: 300px; overflow-y: auto;">
                                                <div id="subscribers-list" class="list-group list-group-flush">
                                                    <div class="text-center py-2 text-muted">
                                                        Select a group to see subscribers
                                                    </div>
                                                </div>
                                            </div>
                                            <!-- Hidden input to store excluded subscribers -->
                                            <input type="hidden" id="id_excluded_subscribers" name="excluded_subscribers">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Additional email addresses -->
                                <div class="mb-3">
                                    <label for="additional-emails" class="form-label">Additional Email Addresses</label>
                                    <textarea class="form-control" id="additional-emails" name="additional_emails" rows="3" 
                                              placeholder="Enter email addresses (one per line or comma-separated)"></textarea>
                                    <div class="form-text">These addresses will receive the newsletter even if they're not subscribers</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Delivery Options -->
                    <div class="col-md-4">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Delivery Options</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label d-block">When to send</label>
                                    <div class="btn-group w-100" role="group">
                                        <input type="radio" class="btn-check" name="delivery_option" id="send_now" value="now" checked autocomplete="off">
                                        <label class="btn btn-outline-primary" for="send_now">Send Now</label>
                                        
                                        <input type="radio" class="btn-check" name="delivery_option" id="schedule" value="schedule" autocomplete="off">
                                        <label class="btn btn-outline-primary" for="schedule">Schedule</label>
                                    </div>
                                </div>
                                
                                <div id="schedule-date-container" class="mb-3 d-none">
                                    <label for="{{ form.scheduled_date.id_for_label }}" class="form-label">Scheduled Date and Time</label>
                                    {{ form.scheduled_date }}
                                </div>
                                
                                <!-- Hidden fields for form processing -->
                                <input type="hidden" name="send_now" id="id_send_now" value="true">
                                <input type="hidden" name="schedule_send" id="id_schedule_send" value="false">
                                <input type="hidden" name="status" id="id_status" value="draft">
                            </div>
                        </div>
                        
                        <!-- Recipients Summary -->
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">Delivery Summary</h5>
                                <span class="badge bg-primary" id="total-recipients-badge">0 recipients</span>
                            </div>
                            <div class="card-body">
                                <p class="text-muted small mb-3">
                                    <i class="fas fa-info-circle me-1"></i> unique subscribers + additional emails - excluded subscribers
                                </p>
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>Raw Subscriber Count:</span>
                                        <span class="fw-bold" id="raw-subscriber-count">0</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>Selected Groups:</span>
                                        <span id="selected-groups-count">0</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>Additional Emails:</span>
                                        <span id="additional-emails-count">0</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>Excluded Subscribers:</span>
                                        <span id="excluded-count">0</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="d-flex justify-content-between">
                    <a href="{% url 'newsletter:newsletter_list' %}" class="btn btn-outline-secondary">Cancel</a>
                    <div>
                        <button type="submit" name="save_as_draft" class="btn btn-outline-primary me-2">Save as Draft</button>
                        <button type="submit" name="save_and_preview" class="btn btn-primary">Save and Preview</button>
                    </div>
                </div>
                
                <script>
// Natychmiastowe rozwiązanie problemu z wyszukiwarką grup
document.addEventListener('DOMContentLoaded', function() {
    // Ten skrypt dodaje bezpośrednie pola formularza dla każdej zaznaczonej grupy
    const form = document.getElementById('newsletter-form');
    
    // Dodajemy obsługę submitu formularza, aby dodać pola dla zaznaczonych grup
    form.addEventListener('submit', function(e) {
        // Sprawdź, czy to przycisk "Save as Draft" - jeśli tak, nie rób walidacji
        const isDraft = e.submitter && e.submitter.name === 'save_as_draft';
        
        // Znajdź wszystkie zaznaczone checkbox'y grup
        const checkedGroups = document.querySelectorAll('.group-checkbox:checked');
        
        // Jeśli nie ma zaznaczonych grup i nie jest to draft, sprawdź dodatkowe maile
        if (!isDraft && checkedGroups.length === 0) {
            const additionalEmails = document.getElementById('additional-emails');
            const hasEmails = additionalEmails && additionalEmails.value.trim();
            
            if (!hasEmails) {
                alert('You must select at least one recipient or group, or provide additional email addresses.');
                e.preventDefault();
                return false;
            }
        }
        
        // Usuń wszystkie istniejące ukryte pola dla grup
        document.querySelectorAll('input[name="subscriber_groups"]').forEach(field => field.remove());
        
        // Dodaj nowe ukryte pole dla każdej zaznaczonej grupy
        checkedGroups.forEach(checkbox => {
            const hiddenField = document.createElement('input');
            hiddenField.type = 'hidden';
            hiddenField.name = 'subscriber_groups';
            hiddenField.value = checkbox.value;
            form.appendChild(hiddenField);
        });
        
        // Pozwól formularzowi kontynuować wysyłanie
        return true;
    });
    
    // Monitoruj wyszukiwarkę grup - zachowaj zaznaczone wartości
    const groupSearch = document.getElementById('group-search');
    if (groupSearch) {
        groupSearch.addEventListener('input', function() {
            // Zapisz wszystkie aktualnie zaznaczone grupy
            const checkedGroupIds = [];
            document.querySelectorAll('.group-checkbox:checked').forEach(cb => {
                checkedGroupIds.push(cb.value);
            });
            
            // Po zakończeniu wyszukiwania, odtwórz zaznaczenie
            setTimeout(function() {
                checkedGroupIds.forEach(id => {
                    const checkbox = document.querySelector(`.group-checkbox[value="${id}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });
            }, 100);
        });
    }
});
</script>
                
            </form>
        </div>
    </div>
{% endblock %}

{% block extra_js %}



<script>
/**
 * Newsletter Form Handling
 * Implements recipient selection and management
 */
document.addEventListener('DOMContentLoaded', function() {
    console.log('Newsletter form script loaded');

    // Element references
    const form = document.getElementById('newsletter-form');
    const sendNowRadio = document.getElementById('send_now');
    const scheduleRadio = document.getElementById('schedule');
    const scheduleDateContainer = document.getElementById('schedule-date-container');
    const sendNowInput = document.getElementById('id_send_now');
    const scheduleInput = document.getElementById('id_schedule_send');
    const statusInput = document.getElementById('id_status');
    
    // Buttons references
    const saveAsDraftBtn = document.querySelector('button[name="save_as_draft"]');
    const saveAndPreviewBtn = document.querySelector('button[name="save_and_preview"]');
    
    // Groups and subscribers elements
    const groupSearchInput = document.getElementById('group-search');
    const clearGroupSearchBtn = document.getElementById('clear-group-search');
    const groupsList = document.getElementById('groups-list');
    const groupsInput = document.getElementById('id_subscriber_groups');
    
    const subscriberSearchInput = document.getElementById('subscriber-search');
    const clearSubscriberSearchBtn = document.getElementById('clear-subscriber-search');
    const subscribersList = document.getElementById('subscribers-list');
    const excludedSubscribersInput = document.getElementById('id_excluded_subscribers');
    
    const additionalEmailsTextarea = document.getElementById('additional-emails');
    
    // Data storage
    let allGroups = [];
    let selectedGroups = [];
    let allSubscribers = [];
    let excludedSubscribers = [];

    /**
     * Override form submission to bypass hidden field issues 
     */
    if (form) {
        form.addEventListener('submit', function(e) {
            // For save as draft, we don't need validation
            if (e.submitter && e.submitter.name === 'save_as_draft') {
                // Just make sure the draft flag is set
                const draftInput = document.createElement('input');
                draftInput.type = 'hidden';
                draftInput.name = 'is_draft';
                draftInput.value = 'true';
                this.appendChild(draftInput);
                return true; // Let the form submit normally
            }

            // For other submissions, ensure we have recipients
            const checkedGroups = document.querySelectorAll('.group-checkbox:checked');
            const additionalEmails = document.getElementById('additional-emails');
            const hasEmails = additionalEmails && additionalEmails.value.trim().length > 0;
            
            console.log('Form submission intercepted');
            console.log('- Checked groups count:', checkedGroups.length);
            console.log('- Has additional emails:', hasEmails);
            
            // Validate - must have at least one group or additional email
            if (checkedGroups.length === 0 && !hasEmails) {
                e.preventDefault(); // Stop form submission
                alert('You must select at least one recipient or group, or provide additional email addresses.');
                return false;
            }
            
            // Clear any existing hidden fields for groups
            const existingFields = form.querySelectorAll('input[name="direct_group_ids"]');
            existingFields.forEach(field => field.remove());
            
            // Add fresh hidden fields for selected groups
            checkedGroups.forEach(checkbox => {
                const field = document.createElement('input');
                field.type = 'hidden';
                field.name = 'direct_group_ids';
                field.value = checkbox.value;
                form.appendChild(field);
                console.log('Added group ID:', checkbox.value);
            });
            
            // For save_and_preview, we need to add a field
            if (e.submitter && e.submitter.name === 'save_and_preview') {
                const previewInput = document.createElement('input');
                previewInput.type = 'hidden';
                previewInput.name = 'save_and_preview';
                previewInput.value = 'true';
                form.appendChild(previewInput);
            }
            
            return true; // Continue with form submission
        });
    }
    
    /**
     * Load all subscriber groups from API
     */
    function loadGroups() {
        console.log('Loading groups...');
        groupsList.innerHTML = '<div class="text-center py-2"><div class="spinner-border spinner-border-sm" role="status"></div><span class="ms-2">Loading groups...</span></div>';
        
        // Fetch subscriber groups from the API
        fetch('/newsletter/api/subscriber-groups/')
            .then(response => response.json())
            .then(data => {
                console.log('Groups loaded:', data);
                allGroups = data;
                renderGroupsList();
            })
            .catch(error => {
                console.error('Error loading groups:', error);
                groupsList.innerHTML = '<div class="text-center py-2 text-danger">Error loading groups</div>';
            });
    }
    
    /**
     * Render groups list with checkboxes
     */
    function renderGroupsList(searchTerm = '') {
        console.log('Rendering groups list. Search term:', searchTerm);
        console.log('Selected groups before rendering:', selectedGroups);
        
        // Save current checked state before clearing the list
        const checkedGroupIds = [];
        document.querySelectorAll('.group-checkbox:checked').forEach(cb => {
            checkedGroupIds.push(parseInt(cb.value));
        });
        console.log('Currently checked group IDs:', checkedGroupIds);
        
        // Merge with selectedGroups to make sure we don't lose selections
        selectedGroups = [...new Set([...selectedGroups, ...checkedGroupIds])];
        console.log('Updated selected groups:', selectedGroups);
        
        // Now clear and rebuild the list
        groupsList.innerHTML = '';
        
        if (allGroups.length === 0) {
            groupsList.innerHTML = '<div class="text-center py-2 text-muted">No groups available</div>';
            return;
        }
        
        // Filter by search term if provided
        const filteredGroups = searchTerm 
            ? allGroups.filter(group => group.group_name.toLowerCase().includes(searchTerm.toLowerCase()))
            : allGroups;
        
        if (filteredGroups.length === 0) {
            groupsList.innerHTML = '<div class="text-center py-2 text-muted">No groups match your search</div>';
            return;
        }
        
        // Create group items with checkboxes
        filteredGroups.forEach(group => {
            const item = document.createElement('div');
            item.className = 'list-group-item d-flex justify-content-between align-items-center p-2';
            
            // Checkbox
            const checkboxDiv = document.createElement('div');
            checkboxDiv.className = 'form-check';
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'form-check-input group-checkbox';
            checkbox.id = `group-${group.id}`;
            checkbox.value = group.id;
            
            // IMPORTANT: Check the box if this group is in selectedGroups
            checkbox.checked = selectedGroups.includes(parseInt(group.id)) || selectedGroups.includes(group.id);
            
            checkbox.addEventListener('change', function() {
                handleGroupSelection(parseInt(group.id), this.checked);
            });
            
            const label = document.createElement('label');
            label.className = 'form-check-label';
            label.htmlFor = `group-${group.id}`;
            label.textContent = group.group_name;
            
            checkboxDiv.appendChild(checkbox);
            checkboxDiv.appendChild(label);
            
            // Subscriber count badge
            const badge = document.createElement('span');
            badge.className = 'badge bg-primary rounded-pill';
            badge.textContent = group.subscriber_count || 0;
            
            item.appendChild(checkboxDiv);
            item.appendChild(badge);
            groupsList.appendChild(item);
        });
        
        // After rendering, update the hidden input to ensure it's current
        updateHiddenInputs();
        
        // Also update subscriber lists if needed
        if (selectedGroups.length > 0) {
            loadGroupSubscribers();
        }
    }
    
    /**
     * Update all hidden inputs with current values
     */
    function updateHiddenInputs() {
        // Always convert to strings before joining
        const groupIdStrings = selectedGroups.map(id => String(id));
        groupsInput.value = groupIdStrings.join(',');
        
        const excludedIdStrings = excludedSubscribers.map(id => String(id));
        excludedSubscribersInput.value = excludedIdStrings.join(',');
        
        console.log('Updated hidden inputs:');
        console.log('- Groups input value:', groupsInput.value);
        console.log('- Excluded subscribers input value:', excludedSubscribersInput.value);
    }
    
    /**
     * Handle group selection/deselection
     */
    function handleGroupSelection(groupId, isSelected) {
        console.log(`Group ${groupId} ${isSelected ? 'selected' : 'deselected'}`);
        
        if (isSelected) {
            if (!selectedGroups.includes(groupId)) {
                selectedGroups.push(groupId);
                loadGroupSubscribers(groupId);
            }
        } else {
            selectedGroups = selectedGroups.filter(id => id !== groupId);
            
            // If this group was deselected, we need to refresh subscribers list
            // for the remaining selected groups
            if (selectedGroups.length > 0) {
                loadGroupSubscribers();
            } else {
                // If no groups selected, clear subscribers list
                subscribersList.innerHTML = '<div class="text-center py-2 text-muted">Select a group to see subscribers</div>';
                allSubscribers = [];
            }
        }
        
        // Update hidden input
        updateHiddenInputs();
        
        updateRecipientsSummary();
    }
    
    /**
     * Load subscribers for selected groups
     */
    function loadGroupSubscribers(newGroupId = null) {
        // If no groups selected, show message
        if (selectedGroups.length === 0) {
            subscribersList.innerHTML = '<div class="text-center py-2 text-muted">Select a group to see subscribers</div>';
            allSubscribers = [];
            return;
        }
        
        // Show loading
        subscribersList.innerHTML = '<div class="text-center py-2"><div class="spinner-border spinner-border-sm" role="status"></div><span class="ms-2">Loading subscribers...</span></div>';
        
        // Based on your API structure, we need to fetch subscribers for each group
        // and combine them
        
        // Track promises for all group subscriber requests
        const fetchPromises = [];
        const allGroupSubscribers = [];
        
        // Fetch subscribers for each selected group
        selectedGroups.forEach(groupId => {
            const promise = fetch(`/newsletter/api/subscriber-groups/${groupId}/subscribers/`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Error fetching subscribers for group ${groupId}`);
                    }
                    return response.json();
                })
                .then(subscribers => {
                    // Add these subscribers to our collection
                    allGroupSubscribers.push(...subscribers);
                })
                .catch(error => {
                    console.error(error);
                    // Continue with other groups even if one fails
                });
            
            fetchPromises.push(promise);
        });
        
        // Wait for all fetch operations to complete
        Promise.all(fetchPromises)
            .then(() => {
                // Remove duplicates (a subscriber might be in multiple groups)
                const uniqueIds = new Set();
                allSubscribers = allGroupSubscribers.filter(subscriber => {
                    if (uniqueIds.has(subscriber.id)) {
                        return false;
                    }
                    uniqueIds.add(subscriber.id);
                    return true;
                });
                
                renderSubscribersList();
            })
            .catch(error => {
                console.error('Error loading group subscribers:', error);
                subscribersList.innerHTML = '<div class="text-center py-2 text-danger">Error loading subscribers</div>';
            });
    }
    
    /**
     * Render subscribers list with exclude checkboxes and consent status
     */
    function renderSubscribersList(searchTerm = '') {
        subscribersList.innerHTML = '';
        
        if (allSubscribers.length === 0) {
            subscribersList.innerHTML = '<div class="text-center py-2 text-muted">No subscribers in selected groups</div>';
            return;
        }
        
        // Filter by search term if provided
        const filteredSubscribers = searchTerm 
            ? allSubscribers.filter(sub => 
                sub.email.toLowerCase().includes(searchTerm.toLowerCase()) || 
                (sub.first_name && sub.first_name.toLowerCase().includes(searchTerm.toLowerCase())) ||
                (sub.last_name && sub.last_name.toLowerCase().includes(searchTerm.toLowerCase())))
            : allSubscribers;
        
        if (filteredSubscribers.length === 0) {
            subscribersList.innerHTML = '<div class="text-center py-2 text-muted">No subscribers match your search</div>';
            return;
        }
        
        // Optional: Add header for columns
        const header = document.createElement('div');
        header.className = 'list-group-item d-flex justify-content-between align-items-center p-2 bg-light';
        header.innerHTML = `
            <div style="width: 60%;" class="small text-muted">Subscriber</div>
            <div style="width: 20%;" class="small text-muted text-center">Consent</div>
            <div style="width: 20%;" class="small text-muted text-end">Include</div>
        `;
        subscribersList.appendChild(header);
        
        // Create subscriber items with exclude checkboxes and consent status
        filteredSubscribers.forEach(subscriber => {
            const item = document.createElement('div');
            item.className = 'list-group-item d-flex justify-content-between align-items-center p-2';
            
            // Subscriber info
            const infoDiv = document.createElement('div');
            infoDiv.style.width = '60%';
            
            const email = document.createElement('div');
            email.className = 'small fw-bold';
            email.textContent = subscriber.email;
            infoDiv.appendChild(email);
            
            if (subscriber.first_name || subscriber.last_name) {
                const name = document.createElement('div');
                name.className = 'small text-muted';
                name.textContent = `${subscriber.first_name || ''} ${subscriber.last_name || ''}`.trim();
                infoDiv.appendChild(name);
            }
            
            // Consent status
            const consentDiv = document.createElement('div');
            consentDiv.style.width = '20%';
            consentDiv.className = 'text-center';
            
            const hasConsent = subscriber.newsletter_consent === true;
            const consentBadge = document.createElement('span');
            
            if (hasConsent) {
                consentBadge.className = 'badge badge-active';
                consentBadge.innerHTML = '<i class="fas fa-check-circle me-1"></i>Yes';
            } else {
                consentBadge.className = 'badge badge-inactive';
                consentBadge.innerHTML = '<i class="fas fa-times-circle me-1"></i>No';
            }
            
            consentDiv.appendChild(consentBadge);
            
            // Exclude checkbox in its own div
            const excludeDiv = document.createElement('div');
            excludeDiv.style.width = '20%';
            excludeDiv.className = 'text-end';
            
            const formCheck = document.createElement('div');
            formCheck.className = 'form-check form-switch';
            formCheck.style.display = 'inline-block'; // Better alignment
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'form-check-input exclude-checkbox';
            checkbox.id = `exclude-${subscriber.id}`;
            checkbox.value = subscriber.id;
            checkbox.checked = !excludedSubscribers.includes(subscriber.id);
            checkbox.addEventListener('change', function() {
                handleSubscriberExclusion(subscriber.id, !this.checked);
            });
            
            const label = document.createElement('label');
            label.className = 'form-check-label';
            label.htmlFor = `exclude-${subscriber.id}`;
            label.textContent = 'Include';
            
            formCheck.appendChild(checkbox);
            // Uncomment if you want the label
            // formCheck.appendChild(label);
            excludeDiv.appendChild(formCheck);
            
            // Add all elements to the item
            item.appendChild(infoDiv);
            item.appendChild(consentDiv);
            item.appendChild(excludeDiv);
            subscribersList.appendChild(item);
        });
    }
    
    /**
     * Handle subscriber exclusion/inclusion
     */
    function handleSubscriberExclusion(subscriberId, isExcluded) {
        if (isExcluded) {
            if (!excludedSubscribers.includes(subscriberId)) {
                excludedSubscribers.push(subscriberId);
            }
        } else {
            excludedSubscribers = excludedSubscribers.filter(id => id !== subscriberId);
        }
        
        // Update hidden input
        updateHiddenInputs();
        
        updateRecipientsSummary();
    }
    
    /**
     * Parse additional emails from textarea
     */
    function parseAdditionalEmails() {
        const text = additionalEmailsTextarea.value.trim();
        if (!text) return [];
        
        // Split by commas or newlines
        const emails = text.split(/[\n,]+/).map(email => email.trim()).filter(email => email);
        
        // Validate emails (basic validation)
        return emails.filter(email => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email));
    }
    
    /**
     * Update delivery options based on radio selection
     */
    function updateDeliveryOptions() {
        if (sendNowRadio.checked) {
            scheduleDateContainer.classList.add('d-none');
            sendNowInput.value = 'true';
            scheduleInput.value = 'false';
        } else {
            scheduleDateContainer.classList.remove('d-none');
            sendNowInput.value = 'false';
            scheduleInput.value = 'true';
        }
        
        // Always set status to draft initially
        statusInput.value = 'draft';
    }
    
    /**
     * Update recipients summary
     */
    function updateRecipientsSummary() {
        // Get count of additional emails
        const additionalEmails = parseAdditionalEmails();
        const additionalCount = additionalEmails.length;
        
        // Calculate raw total of subscribers in all selected groups (without deduplication)
        let rawSubscribersTotal = 0;
        selectedGroups.forEach(groupId => {
            const group = allGroups.find(g => g.id == groupId);
            if (group && group.subscriber_count) {
                rawSubscribersTotal += group.subscriber_count;
            }
        });
        
        // Show loading state
        document.getElementById('total-recipients-badge').textContent = 'Calculating unique recipients with consent...';
        
        // Build query parameters
        const params = new URLSearchParams();
        
        // Add selected group IDs - convert to strings
        selectedGroups.forEach(id => params.append('group_ids', String(id)));
        
        // Log query parameters
        console.log('Query parameters for count API:', params.toString());
        
        // Make API request to get deduplicated count
        fetch(`/newsletter/api/recipients/count/?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                console.log('Recipients count API response:', data);
                const groupCount = selectedGroups.length;
                const excludedCount = excludedSubscribers.length;
                
                // Get unique subscriber count from API (which should NOT include exclusions yet)
                const uniqueSubscribers = data.total_unique || 0;
                
                // Calculate final recipient count: unique subscribers + additional - excluded
                const netTotalCount = uniqueSubscribers + additionalCount - excludedCount;
                
                // Update display with the counts
                updateCountDisplay(rawSubscribersTotal, netTotalCount, groupCount, additionalCount, excludedCount);
            })
            .catch(error => {
                console.error('Error calculating recipients:', error);
                
                // Fallback calculation if API fails:
                // Calculate approximate unique count by estimating deduplication
                let uniqueEstimate = rawSubscribersTotal;
                
                // Reduce by a reasonable factor if multiple groups (to account for possible duplicates)
                if (selectedGroups.length > 1) {
                    uniqueEstimate = Math.floor(rawSubscribersTotal * 0.9); // Estimate 10% overlap
                }
                
                // Calculate net total as: estimated unique subscribers + additional emails - excluded
                const netTotal = Math.max(0, uniqueEstimate - excludedCount) + additionalCount;
                
                updateCountDisplay(rawSubscribersTotal, netTotal, selectedGroups.length, additionalCount, excludedCount);
            });
    }
    
    /**
     * Update count display elements
     */
    function updateCountDisplay(rawTotal, netTotal, groupCount, additionalCount, excludedCount) {
        // Set the raw total count (simple sum of all subscribers in all groups)
        document.getElementById('raw-subscriber-count').textContent = rawTotal;
        
        // Set other counts
        document.getElementById('selected-groups-count').textContent = groupCount;
        document.getElementById('additional-emails-count').textContent = additionalCount;
        document.getElementById('excluded-count').textContent = excludedCount;
        
        // Update the badge with net total (actual recipients with consent)
        document.getElementById('total-recipients-badge').textContent = `${netTotal} unique recipients with consent`;
    }
    
    /**
     * Initialize the search functionality
     */
    function initializeSearch() {
        console.log('Initializing search functionality');
        
        // Group search
        groupSearchInput.addEventListener('input', debounce(function() {
            const searchTerm = this.value.trim();
            console.log('Searching groups:', searchTerm);
            renderGroupsList(searchTerm);
        }, 300));
        
        clearGroupSearchBtn.addEventListener('click', function() {
            groupSearchInput.value = '';
            renderGroupsList();
        });
        
        // Subscriber search
        subscriberSearchInput.addEventListener('input', debounce(function() {
            const searchTerm = this.value.trim();
            renderSubscribersList(searchTerm);
        }, 300));
        
        clearSubscriberSearchBtn.addEventListener('click', function() {
            subscriberSearchInput.value = '';
            renderSubscribersList();
        });
    }
    
    // Utility function for debouncing
    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), wait);
        };
    }
    
    // Initialize everything
    loadGroups();
    updateDeliveryOptions();
    updateRecipientsSummary();
    initializeSearch();
    
    // Additional debugging info
    console.log('Initial form state:');
    console.log('- Form element:', form);
    console.log('- Groups input element:', groupsInput);
    console.log('- Excluded subscribers input element:', excludedSubscribersInput);
    
    // Direct DOM check for form elements
    if (!form) console.error('Form element not found!');
    if (!groupsInput) console.error('Groups input not found!');
    if (!excludedSubscribersInput) console.error('Excluded subscribers input not found!');
});
</script>
{% endblock %}