{% extends "base.html" %}
{% load static %}

{% block title %}Utwórz Newsletter | XManager{% endblock %}

{% block page_title %}Utwórz Newsletter{% endblock %}

{% block page_actions %}
    <a href="{% url 'newsletter:newsletter_list' %}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-1"></i> Powrót do Newsletterów
    </a>
{% endblock %}

{% block content %}
{% if edit_mode %}
<input type="hidden" name="newsletter_id" value="{{ newsletter.id }}">
{% endif %}
    <div class="card">
        <div class="card-body">
            <!-- Nawigacja kroków kreatora -->
            <div class="wizard-navigation mb-4">
                <div class="progress" style="height: 3px;">
                    <div class="progress-bar" role="progressbar" style="width: 33%;" aria-valuenow="33" aria-valuemin="0" aria-valuemax="100" id="wizard-progress-bar"></div>
                </div>
                <ul class="nav nav-pills nav-wizard" id="wizardSteps" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="step1-tab" data-bs-toggle="pill" data-bs-target="#step1" type="button" role="tab" aria-controls="step1" aria-selected="true">
                            <span class="wizard-step-icon">1</span>
                            <span class="wizard-step-text">Treść</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="step2-tab" data-bs-toggle="pill" data-bs-target="#step2" type="button" role="tab" aria-controls="step2" aria-selected="false">
                            <span class="wizard-step-icon">2</span>
                            <span class="wizard-step-text">Odbiorcy</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="step3-tab" data-bs-toggle="pill" data-bs-target="#step3" type="button" role="tab" aria-controls="step3" aria-selected="false">
                            <span class="wizard-step-icon">3</span>
                            <span class="wizard-step-text">Wysyłka</span>
                        </button>
                    </li>
                </ul>
            </div>

            <form method="post" id="newsletter-form">
                {% csrf_token %}
                
                {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                        {% for error in form.non_field_errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                {% endif %}
                
                <div class="tab-content" id="wizardTabContent">
                    <!-- Krok 1: Treść -->
                    <div class="tab-pane fade show active" id="step1" role="tabpanel" aria-labelledby="step1-tab">
                        <h4 class="mb-4">Treść Newslettera</h4>
                        
                        <!-- Temat -->
                        <div class="mb-4">
                            <label for="{{ form.subject.id_for_label }}" class="form-label">Temat *</label>
                            {{ form.subject }}
                            {% if form.subject.errors %}
                                <div class="invalid-feedback d-block">{{ form.subject.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <!-- Szablon -->
                        <div class="mb-4">
                            <label for="{{ form.template.id_for_label }}" class="form-label">Szablon</label>
                            <select id="{{ form.template.id_for_label }}" name="{{ form.template.html_name }}" class="form-select">
                                <option value="">Domyślny Szablon</option>
                                {% for template in templates %}
                                    <option value="{{ template.id }}">{{ template.name }}</option>
                                {% endfor %}
                            </select>
                            {% if form.template.errors %}
                                <div class="invalid-feedback d-block">{{ form.template.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <!-- Treść -->
                        <div class="mb-4">
                            <label for="{{ form.content.id_for_label }}" class="form-label">Treść *</label>
                            {{ form.content }}
                            {% if form.content.errors %}
                                <div class="invalid-feedback d-block">{{ form.content.errors.0 }}</div>
                            {% endif %}
                            <div class="form-text">Możesz użyć Markdown lub HTML w treści.</div>
                        </div>
                        
                        <!-- Załączniki -->
                        <div class="mb-4">
                            <label class="form-label">Załączniki</label>
                            <div class="input-group mb-2">
                                <input type="file" class="form-control" id="attachment" name="attachment" multiple>
                                <button class="btn btn-outline-secondary" type="button" id="clear-attachments">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="form-text">Maksymalnie 5 plików, po 10MB każdy. Dozwolone formaty: PDF, DOC, DOCX, JPG, PNG</div>
                            <div id="attachment-list" class="list-group mt-2"></div>
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            <button type="button" class="btn btn-outline-secondary" disabled>Poprzedni</button>
                            <button type="button" class="btn btn-primary next-step" data-next="step2">Dalej: Odbiorcy</button>
                        </div>
                    </div>
                    
                    <!-- Krok 2: Odbiorcy -->
                    <div class="tab-pane fade" id="step2" role="tabpanel" aria-labelledby="step2-tab">
                        <h4 class="mb-4">Odbiorcy Newslettera</h4>
                        
                        <div class="row">
                            <!-- Lewa strona: Lista grup -->
                            <div class="col-md-5">
                                <div class="mb-4">
                                    <label class="form-label">Grupy Subskrybentów</label>
                                    <div class="input-group mb-2">
                                        <input type="text" class="form-control" id="group-search" placeholder="Szukaj grup...">
                                        <button class="btn btn-outline-secondary" type="button" id="clear-group-search">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                    <div class="border rounded p-2" style="height: 300px; overflow-y: auto;">
                                        <div id="groups-list" class="list-group list-group-flush">
                                            <div class="text-center py-2">
                                                <div class="spinner-border spinner-border-sm" role="status"></div>
                                                <span class="ms-2">Ładowanie grup...</span>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Ukryte pole do przechowywania wybranych grup -->
                                    <input type="hidden" id="id_subscriber_groups" name="subscriber_groups">
                                </div>
                            </div>
                            
                            <!-- Prawa strona: Subskrybenci z wybranych grup -->
                            <div class="col-md-7">
                                <div class="mb-4">
                                    <label class="form-label">Subskrybenci z Wybranych Grup</label>
                                    <div class="input-group mb-2">
                                        <input type="text" class="form-control" id="subscriber-search" placeholder="Szukaj subskrybentów...">
                                        <button class="btn btn-outline-secondary" type="button" id="clear-subscriber-search">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                    <div class="border rounded p-2" style="height: 300px; overflow-y: auto;">
                                        <div id="subscribers-list" class="list-group list-group-flush">
                                            <div class="text-center py-2 text-muted">
                                                Wybierz grupę, aby zobaczyć subskrybentów
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Ukryte pole do przechowywania wykluczonych subskrybentów -->
                                    <input type="hidden" id="id_excluded_subscribers" name="excluded_subscribers">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Dodatkowe adresy email -->
                        <div class="mb-4">
                            <label for="additional-emails" class="form-label">Dodatkowe Adresy Email</label>
                            <textarea class="form-control" id="additional-emails" name="additional_emails" rows="3" 
                                      placeholder="Wprowadź adresy email (po jednym w linii lub oddzielone przecinkami)"></textarea>
                            <div class="form-text">Te adresy otrzymają newsletter nawet jeśli nie są subskrybentami</div>
                        </div>
                        
                        <!-- Podsumowanie odbiorców -->
                        <div class="card my-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">Podsumowanie Odbiorców</h5>
                                <span class="badge bg-primary" id="total-recipients-badge">0 odbiorców</span>
                            </div>
                            <div class="card-body">
                                <p class="text-muted small mb-3">
                                    <i class="fas fa-info-circle me-1"></i> unikalni subskrybenci + dodatkowe emaile - wykluczeni subskrybenci
                                </p>
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>Łączna Liczba Subskrybentów:</span>
                                        <span class="fw-bold" id="raw-subscriber-count">0</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>Wybrane Grupy:</span>
                                        <span id="selected-groups-count">0</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>Dodatkowe Emaile:</span>
                                        <span id="additional-emails-count">0</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>Wykluczeni Subskrybenci:</span>
                                        <span id="excluded-count">0</span>
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            <button type="button" class="btn btn-outline-secondary prev-step" data-prev="step1">Poprzedni: Treść</button>
                            <button type="button" class="btn btn-primary next-step" data-next="step3">Dalej: Wysyłka</button>
                        </div>
                    </div>
                    
                    <!-- Krok 3: Wysyłka -->
                    <div class="tab-pane fade" id="step3" role="tabpanel" aria-labelledby="step3-tab">
                        <h4 class="mb-4">Opcje Wysyłki</h4>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <!-- Kiedy wysłać -->
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h5 class="card-title mb-0">Kiedy wysłać</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <div class="btn-group w-100" role="group">
                                                <input type="radio" class="btn-check" name="delivery_option" id="send_now" value="now" checked autocomplete="off">
                                                <label class="btn btn-outline-primary" for="send_now">Wyślij Teraz</label>
                                                
                                                <input type="radio" class="btn-check" name="delivery_option" id="schedule" value="schedule" autocomplete="off">
                                                <label class="btn btn-outline-primary" for="schedule">Zaplanuj</label>
                                            </div>
                                        </div>
                                        
                                        <div id="schedule-date-container" class="mb-4 d-none">
                                            <label for="schedule_datetime" class="form-label">Zaplanowana Data i Godzina</label>
                                            <div class="input-group">
                                                <input type="date" class="form-control" id="schedule_date" name="schedule_date" min="{{ today_date|date:'Y-m-d' }}">
                                                <input type="time" class="form-control" id="schedule_time" name="schedule_time" value="12:00">
                                            </div>
                                            <div class="form-text">Wybierz przyszłą datę i godzinę, kiedy newsletter ma zostać wysłany</div>
                                        </div>
                                        
                                        <!-- Ukryte pola do przetwarzania formularza -->
                                        <input type="hidden" name="send_now" id="id_send_now" value="true">
                                        <input type="hidden" name="schedule_send" id="id_schedule_send" value="false">
                                        <input type="hidden" name="status" id="id_status" value="draft">
                                    </div>
                                </div>
                                
                                <!-- Ustawienia dostarczania -->
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h5 class="card-title mb-0">Ustawienia Dostarczania</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="throttle_rate" class="form-label">Tempo wysyłki (emaili na minutę)</label>
                                            <select class="form-select" id="throttle_rate" name="throttle_rate">
                                                <option value="10">10 emaili/minutę (zalecane)</option>
                                                <option value="20">20 emaili/minutę</option>
                                                <option value="50">50 emaili/minutę</option>
                                                <option value="100">100 emaili/minutę (może uruchomić filtry antyspamowe)</option>
                                                <option value="0">Bez limitu (niezalecane)</option>
                                            </select>
                                            <div class="form-text">Niższe tempo poprawia dostarczalność</div>
                                        </div>
                                        
                                        <div class="mb-3 form-check">
                                            <input type="checkbox" class="form-check-input" id="add_tracking" name="add_tracking" checked>
                                            <label class="form-check-label" for="add_tracking">Dodaj kody śledzenia do linków</label>
                                            <div class="form-text">Śledź kliknięcia i otwarcia w newsletterze</div>
                                        </div>
                                        
                                        <div class="mb-3 form-check">
                                            <input type="checkbox" class="form-check-input" id="add_unsubscribe" name="add_unsubscribe" checked>
                                            <label class="form-check-label" for="add_unsubscribe">Dodaj link do rezygnacji z subskrypcji</label>
                                            <div class="form-text">Wymagane do zgodności z przepisami antyspamowymi</div>
                                        </div>
                                        
                                        <div class="mb-3 form-check">
                                            <input type="checkbox" class="form-check-input" id="use_uuid" name="use_uuid" checked>
                                            <label class="form-check-label" for="use_uuid">Dodaj unikalne identyfikatory</label>
                                            <div class="form-text">Pomaga zapobiec oznaczaniu wiadomości jako spam</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <!-- Podsumowanie newslettera -->
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h5 class="card-title mb-0">Podsumowanie Newslettera</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="fw-bold">Temat:</label>
                                            <p id="summary-subject">-</p>
                                        </div>
                                        <div class="mb-3">
                                            <label class="fw-bold">Odbiorcy:</label>
                                            <p><span id="summary-recipients">0</span> odbiorców otrzyma ten newsletter</p>
                                        </div>
                                        <div class="mb-3">
                                            <label class="fw-bold">Wysyłka:</label>
                                            <p id="summary-delivery">Wyślij natychmiast</p>
                                        </div>
                                        <div class="mb-3 d-none" id="summary-schedule-container">
                                            <label class="fw-bold">Zaplanowano na:</label>
                                            <p id="summary-schedule-time">-</p>
                                        </div>
                                        <div class="mb-3">
                                            <label class="fw-bold">Załączniki:</label>
                                            <p id="summary-attachments">Brak</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Kontrola antyspamowa -->
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h5 class="card-title mb-0">Wyniki Kontroli Spamu</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between mb-3">
                                            <span>Ocena spamu:</span>
                                            <div class="progress flex-grow-1 mx-2" style="height: 20px;">
                                                <div class="progress-bar bg-success" role="progressbar" style="width: 15%;" aria-valuenow="15" aria-valuemin="0" aria-valuemax="100" id="spam-score-bar">15%</div>
                                            </div>
                                            <span class="badge bg-success">Niskie ryzyko</span>
                                        </div>
                                        
                                        <ul class="list-group list-group-flush" id="spam-check-list">
                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                <span>Temat nie wygląda jak spam</span>
                                                <i class="fas fa-check-circle text-success"></i>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                <span>Treść ma dobry stosunek tekstu do obrazów</span>
                                                <i class="fas fa-check-circle text-success"></i>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                <span>Zawiera link do rezygnacji z subskrypcji</span>
                                                <i class="fas fa-check-circle text-success"></i>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                <span>Brak nadmiernego użycia wielkich liter</span>
                                                <i class="fas fa-check-circle text-success"></i>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between align-items-center text-warning">
                                                <span>Treść zawiera potencjalnie spamowe słowa</span>
                                                <i class="fas fa-exclamation-triangle text-warning"></i>
                                            </li>
                                        </ul>
                                        <button type="button" id="run-spam-check" class="btn btn-sm btn-outline-primary mt-3 w-100">
                                            <i class="fas fa-sync-alt me-2"></i> Uruchom kontrolę spamu ponownie
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            <button type="button" class="btn btn-outline-secondary prev-step" data-prev="step2">Poprzedni: Odbiorcy</button>
                            <div>
                                <button type="submit" name="save_as_draft" class="btn btn-outline-secondary me-1">Zapisz jako Szkic</button>
                                <button type="submit" name="send_test" class="btn btn-outline-primary me-1">Wyślij Testowy Email</button>
                                <button type="submit" name="save_and_preview" class="btn btn-outline-primary me-1">Podgląd</button>
                                <button type="submit" name="save_and_send" class="btn btn-primary">Wyślij Newsletter</button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
{% endblock %}

{% block extra_css %}
<style>
/* Stylizacja nawigacji kreatora */
.nav-wizard {
    display: flex;
    justify-content: space-between;
    margin-top: -1.5rem;
    position: relative;
    z-index: 1;
}

.nav-wizard .nav-item {
    flex: 1;
    text-align: center;
}

.nav-wizard .nav-link {
    padding: 0;
    margin-top: 0;
    background-color: transparent !important;
    color: #6c757d;
}

.nav-wizard .nav-link.active {
    color: #0d6efd;
}

.wizard-step-icon {
    display: inline-flex;
    width: 2.5rem;
    height: 2.5rem;
    background-color: #f8f9fa;
    border: 2px solid #dee2e6;
    border-radius: 50%;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-bottom: 0.5rem;
}

.nav-wizard .nav-link.active .wizard-step-icon {
    background-color: #0d6efd;
    border-color: #0d6efd;
    color: white;
}

.wizard-step-text {
    display: block;
    font-size: 0.875rem;
}

/* Stylizacja znacznika dla zgody */
.badge-active {
    background-color: #198754;
    color: white;
}

.badge-inactive {
    background-color: #dc3545;
    color: white;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
/**
 * Kreator Formularza Newslettera
 */
document.addEventListener('DOMContentLoaded', function() {
    console.log('Skrypt kreatora newslettera załadowany');

    // Referencje do elementów
    const form = document.getElementById('newsletter-form');
    const wizardTabs = document.querySelectorAll('#wizardSteps .nav-link');
    const wizardSteps = document.querySelectorAll('.tab-pane');
    const progressBar = document.getElementById('wizard-progress-bar');
    const nextButtons = document.querySelectorAll('.next-step');
    const prevButtons = document.querySelectorAll('.prev-step');
    
    // Referencje do elementów formularza
    const sendNowRadio = document.getElementById('send_now');
    const scheduleRadio = document.getElementById('schedule');
    const scheduleDateContainer = document.getElementById('schedule-date-container');
    const sendNowInput = document.getElementById('id_send_now');
    const scheduleInput = document.getElementById('id_schedule_send');
    const statusInput = document.getElementById('id_status');
    const subjectInput = document.getElementById('{{ form.subject.id_for_label }}');
    
    // Elementy grup i subskrybentów
    const groupSearchInput = document.getElementById('group-search');
    const clearGroupSearchBtn = document.getElementById('clear-group-search');
    const groupsList = document.getElementById('groups-list');
    const groupsInput = document.getElementById('id_subscriber_groups');
    
    const subscriberSearchInput = document.getElementById('subscriber-search');
    const clearSubscriberSearchBtn = document.getElementById('clear-subscriber-search');
    const subscribersList = document.getElementById('subscribers-list');
    const excludedSubscribersInput = document.getElementById('id_excluded_subscribers');
    
    const additionalEmailsTextarea = document.getElementById('additional-emails');
    
    // Elementy podsumowania
    const summarySubject = document.getElementById('summary-subject');
    const summaryRecipients = document.getElementById('summary-recipients');
    const summaryDelivery = document.getElementById('summary-delivery');
    const summaryScheduleContainer = document.getElementById('summary-schedule-container');
    const summaryScheduleTime = document.getElementById('summary-schedule-time');
    
    // Przechowywanie danych
    let allGroups = [];
    let selectedGroups = [];
    let allSubscribers = [];
    let excludedSubscribers = [];
    let currentStep = 0;
    
    /**
     * Inicjalizacja nawigacji kreatora
     */
    function initWizard() {
        // Konfiguracja nasłuchiwania zdarzeń dla zakładek kreatora
        wizardTabs.forEach((tab, index) => {
            tab.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Zezwalaj na nawigację tylko do kroków, które zostały już obejrzane
                if (index <= currentStep) {
                    activateStep(index);
                }
            });
        });
        
        // Konfiguracja przycisków "Dalej"
        nextButtons.forEach(button => {
            button.addEventListener('click', function() {
                const nextStep = this.getAttribute('data-next');
                
                // Sprawdź bieżący krok przed przejściem dalej
                if (validateCurrentStep()) {
                    // Przejdź do następnego kroku
                    const nextIndex = Array.from(wizardSteps).findIndex(step => step.id === nextStep);
                    if (nextIndex > currentStep) {
                        currentStep = nextIndex;
                    }
                    activateStep(nextIndex);
                    
                    // Aktualizuj podsumowanie przy przejściu do kroku 3
                    if (nextStep === 'step3') {
                        updateSummary();
                    }
                }
            });
        });
        
        // Konfiguracja przycisków "Poprzedni"
        prevButtons.forEach(button => {
            button.addEventListener('click', function() {
                const prevStep = this.getAttribute('data-prev');
                const prevIndex = Array.from(wizardSteps).findIndex(step => step.id === prevStep);
                activateStep(prevIndex);
            });
        });
    }
    
    /**
     * Aktywacja określonego kroku
     */
    function activateStep(stepIndex) {
        // Aktualizacja zakładek
        wizardTabs.forEach((tab, index) => {
            if (index === stepIndex) {
                tab.classList.add('active');
                tab.setAttribute('aria-selected', 'true');
            } else {
                tab.classList.remove('active');
                tab.setAttribute('aria-selected', 'false');
            }
        });
        
        // Aktualizacja paneli treści
        wizardSteps.forEach((step, index) => {
            if (index === stepIndex) {
                step.classList.add('show', 'active');
            } else {
                step.classList.remove('show', 'active');
            }
        });
        
        // Aktualizacja paska postępu
        const progress = Math.floor((stepIndex / (wizardTabs.length - 1)) * 100);
        progressBar.style.width = `${progress}%`;
        progressBar.setAttribute('aria-valuenow', progress);
    }
    
    /**
     * Walidacja bieżącego kroku
     */
    function validateCurrentStep() {
        const activeStep = document.querySelector('.tab-pane.active');
        
        if (activeStep.id === 'step1') {
            // Walidacja kroku zawartości
            const subject = subjectInput.value.trim();
            const content = document.querySelector('textarea[name="content"]').value.trim();
            
            if (!subject) {
                alert('Proszę wprowadzić temat newslettera.');
                subjectInput.focus();
                return false;
            }
            
            if (!content) {
                alert('Proszę wprowadzić treść newslettera.');
                document.querySelector('textarea[name="content"]').focus();
                return false;
            }
            
            return true;
        }
        else if (activeStep.id === 'step2') {
            // Walidacja kroku odbiorców
            const hasGroups = selectedGroups.length > 0;
            const hasEmails = additionalEmailsTextarea && additionalEmailsTextarea.value.trim().length > 0;
            
            if (!hasGroups && !hasEmails) {
                alert('Musisz wybrać co najmniej jedną grupę odbiorców lub podać dodatkowe adresy email.');
                return false;
            }
            
            return true;
        }
        
        return true;
    }
    
    /**
     * Prawidłowa obsługa przesyłania formularza
     */
    if (form) {
        form.addEventListener('submit', function(e) {
            // Sprawdź, który przycisk został kliknięty
            const isDraft = e.submitter && e.submitter.name === 'save_as_draft';
            const isPreview = e.submitter && e.submitter.name === 'save_and_preview';
            const isTestEmail = e.submitter && e.submitter.name === 'send_test';
            const isSend = e.submitter && e.submitter.name === 'save_and_send';
            
            // Dla testowych emaili, zapytaj o adres email testowy
            if (isTestEmail) {
                e.preventDefault();
                
                // Utwórz modal do pobrania adresu testowego
                const modal = document.createElement('div');
                modal.className = 'modal fade';
                modal.id = 'testEmailModal';
                modal.tabIndex = '-1';
                modal.innerHTML = `
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Wyślij Testowy Email</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label for="test_email" class="form-label">Wyślij test na adres email:</label>
                                    <input type="email" class="form-control" id="test_email" required>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                                <button type="button" class="btn btn-primary" id="send-test-btn">Wyślij Test</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Pokaż modal
                const testEmailModal = new bootstrap.Modal(document.getElementById('testEmailModal'));
                testEmailModal.show();
                
                // Obsługa przesłania testowego emaila
                document.getElementById('send-test-btn').addEventListener('click', function() {
                    const testEmail = document.getElementById('test_email').value.trim();
                    
                    if (!testEmail || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(testEmail)) {
                        alert('Proszę wprowadzić poprawny adres email.');
                        return;
                    }
                    
                    // Dodaj testowy email do formularza
                    const testEmailInput = document.createElement('input');
                    testEmailInput.type = 'hidden';
                    testEmailInput.name = 'test_email';
                    testEmailInput.value = testEmail;
                    form.appendChild(testEmailInput);
                    
                    // Dodaj flagę wskazującą, że to testowy email
                    const isTestInput = document.createElement('input');
                    isTestInput.type = 'hidden';
                    isTestInput.name = 'is_test';
                    isTestInput.value = 'true';
                    form.appendChild(isTestInput);
                    
                    // Ukryj modal
                    testEmailModal.hide();
                    
                    // Prześlij formularz
                    form.submit();
                });
                
                // Nie kontynuuj normalnego przesyłania formularza
                return false;
            }
            
            // Dla opcji innych niż szkic, zwaliduj wszystkie kroki
            if (!isDraft && !isPreview) {
                for (let i = 0; i < wizardSteps.length; i++) {
                    const stepIndex = i;
                    activateStep(stepIndex);
                    if (!validateCurrentStep()) {
                        e.preventDefault();
                        return false;
                    }
                }
            }
            
            // Wyczyść istniejące pola, aby uniknąć duplikatów
            form.querySelectorAll('input[name="subscriber_groups"]').forEach(field => field.remove());
            
            // Pobierz wszystkie zaznaczone grupy
            const checkedGroups = document.querySelectorAll('.group-checkbox:checked');
            
            // Dodaj ukryte pole dla każdej wybranej grupy
            checkedGroups.forEach(checkbox => {
                const field = document.createElement('input');
                field.type = 'hidden';
                field.name = 'subscriber_groups';
                field.value = checkbox.value;
                form.appendChild(field);
                console.log('Dodano ID grupy do formularza:', checkbox.value);
            });
            
            // Dodaj ukryte pole dla wykluczonych subskrybentów
            if (excludedSubscribers.length > 0) {
                form.querySelectorAll('input[name="excluded_subscribers"]').forEach(field => field.remove());
                const excludedField = document.createElement('input');
                excludedField.type = 'hidden';
                excludedField.name = 'excluded_subscribers';
                excludedField.value = excludedSubscribers.join(',');
                form.appendChild(excludedField);
            }
            
            // Dodaj odpowiednie flagi w zależności od klikniętego przycisku
            if (isPreview) {
                const previewInput = document.createElement('input');
                previewInput.type = 'hidden';
                previewInput.name = 'save_and_preview';
                previewInput.value = 'true';
                form.appendChild(previewInput);
            } else if (isDraft) {
                const draftInput = document.createElement('input');
                draftInput.type = 'hidden';
                draftInput.name = 'is_draft';
                draftInput.value = 'true';
                form.appendChild(draftInput);
            } else if (isSend) {
                const sendInput = document.createElement('input');
                sendInput.type = 'hidden';
                sendInput.name = 'send_newsletter';
                sendInput.value = 'true';
                form.appendChild(sendInput);
                
                // Potwierdź przed wysłaniem do rzeczywistych odbiorców
                if (!confirm(`Czy na pewno chcesz wysłać ten newsletter do ${document.getElementById('summary-recipients').textContent} odbiorców?`)) {
                    e.preventDefault();
                    return false;
                }
            }
            
            return true;
        });
    }
    
    /**
     * Załaduj wszystkie grupy subskrybentów z API
     */
    function loadGroups() {
        console.log('Ładowanie grup...');
        groupsList.innerHTML = '<div class="text-center py-2"><div class="spinner-border spinner-border-sm" role="status"></div><span class="ms-2">Ładowanie grup...</span></div>';
        
        fetch('/newsletter/api/subscriber-groups/')
            .then(response => response.json())
            .then(data => {
                console.log('Grupy załadowane:', data);
                allGroups = data;
                renderGroupsList();
            })
            .catch(error => {
                console.error('Błąd ładowania grup:', error);
                groupsList.innerHTML = '<div class="text-center py-2 text-danger">Błąd ładowania grup</div>';
            });
    }
    
    /**
     * Renderuj listę grup z polami wyboru
     */
    function renderGroupsList(searchTerm = '') {
        console.log('Renderowanie listy grup. Wyszukiwany termin:', searchTerm);
        console.log('Wybrane grupy przed renderowaniem:', selectedGroups);
        
        // Zapisz aktualny stan zaznaczenia
        const checkedGroupIds = [];
        document.querySelectorAll('.group-checkbox:checked').forEach(cb => {
            checkedGroupIds.push(parseInt(cb.value));
        });
        console.log('Aktualnie zaznaczone ID grup:', checkedGroupIds);
        
        // Połącz z selectedGroups, aby zachować wybory
        selectedGroups = [...new Set([...selectedGroups, ...checkedGroupIds])];
        console.log('Zaktualizowane wybrane grupy:', selectedGroups);
        
        // Wyczyść i odbuduj listę
        groupsList.innerHTML = '';
        
        if (allGroups.length === 0) {
            groupsList.innerHTML = '<div class="text-center py-2 text-muted">Brak dostępnych grup</div>';
            return;
        }
        
        // Filtruj według wyszukiwanego terminu, jeśli podano
        const filteredGroups = searchTerm 
            ? allGroups.filter(group => group.group_name.toLowerCase().includes(searchTerm.toLowerCase()))
            : allGroups;
        
        if (filteredGroups.length === 0) {
            groupsList.innerHTML = '<div class="text-center py-2 text-muted">Żadna grupa nie pasuje do wyszukiwania</div>';
            return;
        }
        
        // Utwórz elementy grup z polami wyboru
        filteredGroups.forEach(group => {
            const item = document.createElement('div');
            item.className = 'list-group-item d-flex justify-content-between align-items-center p-2';
            
            // Pole wyboru
            const checkboxDiv = document.createElement('div');
            checkboxDiv.className = 'form-check';
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'form-check-input group-checkbox';
            checkbox.id = `group-${group.id}`;
            checkbox.value = group.id;
            
            // Sprawdź, czy ta grupa jest wybrana
            checkbox.checked = selectedGroups.includes(parseInt(group.id)) || selectedGroups.includes(group.id);
            
            checkbox.addEventListener('change', function() {
                handleGroupSelection(parseInt(group.id), this.checked);
            });
            
            const label = document.createElement('label');
            label.className = 'form-check-label';
            label.htmlFor = `group-${group.id}`;
            label.textContent = group.group_name;
            
            checkboxDiv.appendChild(checkbox);
            checkboxDiv.appendChild(label);
            
            // Znacznik z liczbą subskrybentów
            const badge = document.createElement('span');
            badge.className = 'badge bg-primary rounded-pill';
            badge.textContent = group.subscriber_count || 0;
            
            item.appendChild(checkboxDiv);
            item.appendChild(badge);
            groupsList.appendChild(item);
        });
        
        // Zaktualizuj również listy subskrybentów, jeśli to potrzebne
        if (selectedGroups.length > 0) {
            loadGroupSubscribers();
        }
    }
    
    /**
     * Aktualizuj wszystkie ukryte pola z bieżącymi wartościami
     */
    function updateHiddenInputs() {
        // Zawsze konwertuj na ciągi znaków przed łączeniem
        const groupIdStrings = selectedGroups.map(id => String(id));
        groupsInput.value = groupIdStrings.join(',');
        
        const excludedIdStrings = excludedSubscribers.map(id => String(id));
        excludedSubscribersInput.value = excludedIdStrings.join(',');
        
        console.log('Zaktualizowano ukryte pola:');
        console.log('- Wartość pola grup:', groupsInput.value);
        console.log('- Wartość pola wykluczonych subskrybentów:', excludedSubscribersInput.value);
    }
    
    /**
     * Obsługa wyboru/odznaczenia grupy
     */
    function handleGroupSelection(groupId, isSelected) {
        console.log(`Grupa ${groupId} ${isSelected ? 'wybrana' : 'odznaczona'}`);
        
        if (isSelected) {
            if (!selectedGroups.includes(groupId)) {
                selectedGroups.push(groupId);
                loadGroupSubscribers(groupId);
            }
        } else {
            selectedGroups = selectedGroups.filter(id => id !== groupId);
            
            // Jeśli ta grupa została odznaczona, musimy odświeżyć listę subskrybentów
            // dla pozostałych wybranych grup
            if (selectedGroups.length > 0) {
                loadGroupSubscribers();
            } else {
                // Jeśli nie wybrano żadnej grupy, wyczyść listę subskrybentów
                subscribersList.innerHTML = '<div class="text-center py-2 text-muted">Wybierz grupę, aby zobaczyć subskrybentów</div>';
                allSubscribers = [];
            }
        }
        
        // Aktualizuj ukryte pole
        updateHiddenInputs();
        
        updateRecipientsSummary();
    }
    
    /**
     * Załaduj subskrybentów dla wybranych grup
     */
    function loadGroupSubscribers(newGroupId = null) {
        // Jeśli nie wybrano żadnej grupy, pokaż komunikat
        if (selectedGroups.length === 0) {
            subscribersList.innerHTML = '<div class="text-center py-2 text-muted">Wybierz grupę, aby zobaczyć subskrybentów</div>';
            allSubscribers = [];
            return;
        }
        
        // Pokaż ładowanie
        subscribersList.innerHTML = '<div class="text-center py-2"><div class="spinner-border spinner-border-sm" role="status"></div><span class="ms-2">Ładowanie subskrybentów...</span></div>';
        
        // Śledź obietnice dla wszystkich żądań grup subskrybentów
        const fetchPromises = [];
        const allGroupSubscribers = [];
        
        // Pobierz subskrybentów dla każdej wybranej grupy
        selectedGroups.forEach(groupId => {
            const promise = fetch(`/newsletter/api/subscriber-groups/${groupId}/subscribers/`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Błąd pobierania subskrybentów dla grupy ${groupId}`);
                    }
                    return response.json();
                })
                .then(subscribers => {
                    // Dodaj tych subskrybentów do naszej kolekcji
                    allGroupSubscribers.push(...subscribers);
                })
                .catch(error => {
                    console.error(error);
                    // Kontynuuj z innymi grupami, nawet jeśli jedna zawiedzie
                });
            
            fetchPromises.push(promise);
        });
        
        // Poczekaj na zakończenie wszystkich operacji pobierania
        Promise.all(fetchPromises)
            .then(() => {
                // Usuń duplikaty (subskrybent może być w wielu grupach)
                const uniqueIds = new Set();
                allSubscribers = allGroupSubscribers.filter(subscriber => {
                    if (uniqueIds.has(subscriber.id)) {
                        return false;
                    }
                    uniqueIds.add(subscriber.id);
                    return true;
                });
                
                renderSubscribersList();
            })
            .catch(error => {
                console.error('Błąd ładowania subskrybentów grup:', error);
                subscribersList.innerHTML = '<div class="text-center py-2 text-danger">Błąd ładowania subskrybentów</div>';
            });
    }
    
    /**
     * Renderuj listę subskrybentów z polami wykluczającymi i statusem zgody
     */
    function renderSubscribersList(searchTerm = '') {
        subscribersList.innerHTML = '';
        
        if (allSubscribers.length === 0) {
            subscribersList.innerHTML = '<div class="text-center py-2 text-muted">Brak subskrybentów w wybranych grupach</div>';
            return;
        }
        
        // Filtruj według wyszukiwanego terminu, jeśli podano
        const filteredSubscribers = searchTerm 
            ? allSubscribers.filter(sub => 
                sub.email.toLowerCase().includes(searchTerm.toLowerCase()) || 
                (sub.first_name && sub.first_name.toLowerCase().includes(searchTerm.toLowerCase())) ||
                (sub.last_name && sub.last_name.toLowerCase().includes(searchTerm.toLowerCase())))
            : allSubscribers;
        
        if (filteredSubscribers.length === 0) {
            subscribersList.innerHTML = '<div class="text-center py-2 text-muted">Żaden subskrybent nie pasuje do wyszukiwania</div>';
            return;
        }
        
        // Opcjonalnie: Dodaj nagłówek dla kolumn
        const header = document.createElement('div');
        header.className = 'list-group-item d-flex justify-content-between align-items-center p-2 bg-light';
        header.innerHTML = `
            <div style="width: 60%;" class="small text-muted">Subskrybent</div>
            <div style="width: 20%;" class="small text-muted text-center">Zgoda</div>
            <div style="width: 20%;" class="small text-muted text-end">Dołącz</div>
        `;
        subscribersList.appendChild(header);
        
        // Utwórz elementy subskrybentów z polami wykluczającymi i statusem zgody
        filteredSubscribers.forEach(subscriber => {
            const item = document.createElement('div');
            item.className = 'list-group-item d-flex justify-content-between align-items-center p-2';
            
            // Informacje o subskrybencie
            const infoDiv = document.createElement('div');
            infoDiv.style.width = '60%';
            
            const email = document.createElement('div');
            email.className = 'small fw-bold';
            email.textContent = subscriber.email;
            infoDiv.appendChild(email);
            
            if (subscriber.first_name || subscriber.last_name) {
                const name = document.createElement('div');
                name.className = 'small text-muted';
                name.textContent = `${subscriber.first_name || ''} ${subscriber.last_name || ''}`.trim();
                infoDiv.appendChild(name);
            }
            
            // Status zgody
            const consentDiv = document.createElement('div');
            consentDiv.style.width = '20%';
            consentDiv.className = 'text-center';
            
            const hasConsent = subscriber.newsletter_consent === true;
            const consentBadge = document.createElement('span');
            
            if (hasConsent) {
                consentBadge.className = 'badge badge-active';
                consentBadge.innerHTML = '<i class="fas fa-check-circle me-1"></i>Tak';
            } else {
                consentBadge.className = 'badge badge-inactive';
                consentBadge.innerHTML = '<i class="fas fa-times-circle me-1"></i>Nie';
            }
            
            consentDiv.appendChild(consentBadge);
            
            // Pole wykluczenia w osobnym div
            const excludeDiv = document.createElement('div');
            excludeDiv.style.width = '20%';
            excludeDiv.className = 'text-end';
            
            const formCheck = document.createElement('div');
            formCheck.className = 'form-check form-switch';
            formCheck.style.display = 'inline-block'; // Lepsze wyrównanie
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'form-check-input exclude-checkbox';
            checkbox.id = `exclude-${subscriber.id}`;
            checkbox.value = subscriber.id;
            checkbox.checked = !excludedSubscribers.includes(subscriber.id);
            checkbox.addEventListener('change', function() {
                handleSubscriberExclusion(subscriber.id, !this.checked);
            });
            
            const label = document.createElement('label');
            label.className = 'form-check-label';
            label.htmlFor = `exclude-${subscriber.id}`;
            label.textContent = 'Dołącz';
            
            formCheck.appendChild(checkbox);
            // formCheck.appendChild(label);
            excludeDiv.appendChild(formCheck);
            
            // Dodaj wszystkie elementy do elementu
            item.appendChild(infoDiv);
            item.appendChild(consentDiv);
            item.appendChild(excludeDiv);
            subscribersList.appendChild(item);
        });
    }
    
    /**
     * Obsługa wykluczenia/włączenia subskrybenta
     */
    function handleSubscriberExclusion(subscriberId, isExcluded) {
        if (isExcluded) {
            if (!excludedSubscribers.includes(subscriberId)) {
                excludedSubscribers.push(subscriberId);
            }
        } else {
            excludedSubscribers = excludedSubscribers.filter(id => id !== subscriberId);
        }
        
        // Aktualizuj ukryte pole
        updateHiddenInputs();
        
        updateRecipientsSummary();
    }
    
    /**
     * Parsuj dodatkowe emaile z pola tekstowego
     */
    function parseAdditionalEmails() {
        const text = additionalEmailsTextarea.value.trim();
        if (!text) return [];
        
        // Podziel według przecinków lub nowych linii
        const emails = text.split(/[\n,]+/).map(email => email.trim()).filter(email => email);
        
        // Zweryfikuj emaile (podstawowa walidacja)
        return emails.filter(email => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email));
    }
    
    /**
     * Aktualizuj opcje dostarczania na podstawie wyboru radio
     */
    function updateDeliveryOptions() {
        if (sendNowRadio.checked) {
            scheduleDateContainer.classList.add('d-none');
            summaryScheduleContainer.classList.add('d-none');
            sendNowInput.value = 'true';
            scheduleInput.value = 'false';
            summaryDelivery.textContent = 'Wyślij natychmiast';
        } else {
            scheduleDateContainer.classList.remove('d-none');
            summaryScheduleContainer.classList.remove('d-none');
            sendNowInput.value = 'false';
            scheduleInput.value = 'true';
            summaryDelivery.textContent = 'Zaplanowana wysyłka';
            
            // Aktualizuj czas wysyłki w podsumowaniu
            const scheduleDateInput = document.getElementById('schedule_date');
            const scheduleTimeInput = document.getElementById('schedule_time');
            
            if (scheduleDateInput && scheduleTimeInput && scheduleDateInput.value && scheduleTimeInput.value) {
                summaryScheduleTime.textContent = `${scheduleDateInput.value} o ${scheduleTimeInput.value}`;
            } else {
                summaryScheduleTime.textContent = 'Nie wybrano daty';
            }
        }
        
        // Zawsze ustaw status jako szkic początkowo
        statusInput.value = 'draft';
    }
    
    /**
     * Aktualizuj podsumowanie odbiorców
     */
    function updateRecipientsSummary() {
        // Pobierz liczbę dodatkowych emaili
        const additionalEmails = parseAdditionalEmails();
        const additionalCount = additionalEmails.length;
        
        // Oblicz surową sumę subskrybentów we wszystkich wybranych grupach (bez deduplikacji)
        let rawSubscribersTotal = 0;
        selectedGroups.forEach(groupId => {
            const group = allGroups.find(g => g.id == groupId);
            if (group && group.subscriber_count) {
                rawSubscribersTotal += group.subscriber_count;
            }
        });
        
        // Pokaż stan ładowania
        document.getElementById('total-recipients-badge').textContent = 'Obliczanie unikalnych odbiorców ze zgodą...';
        
        // Zbuduj parametry zapytania
        const params = new URLSearchParams();
        
        // Dodaj wybrane ID grup - konwertuj na ciągi znaków
        selectedGroups.forEach(id => params.append('group_ids', String(id)));
        
        // Zaloguj parametry zapytania
        console.log('Parametry zapytania do API liczenia:', params.toString());
        
        // Wykonaj żądanie API, aby uzyskać zdeduplikowaną liczbę
        fetch(`/newsletter/api/recipients/count/?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                console.log('Odpowiedź API liczenia odbiorców:', data);
                const groupCount = selectedGroups.length;
                const excludedCount = excludedSubscribers.length;
                
                // Pobierz liczbę unikalnych subskrybentów z API (które NIE powinno jeszcze uwzględniać wykluczeń)
                const uniqueSubscribers = data.total_unique || 0;
                
                // Oblicz końcową liczbę odbiorców: unikalni subskrybenci + dodatkowi - wykluczeni
                const netTotalCount = uniqueSubscribers + additionalCount - excludedCount;
                
                // Aktualizuj wyświetlanie z liczbami
                updateCountDisplay(rawSubscribersTotal, netTotalCount, groupCount, additionalCount, excludedCount);
                
                // Aktualizuj podsumowanie
                summaryRecipients.textContent = netTotalCount;
            })
            .catch(error => {
                console.error('Błąd podczas obliczania odbiorców:', error);
                
                // Rezerwowe obliczenie, jeśli API zawiedzie:
                // Oblicz przybliżoną unikalną liczbę, szacując deduplikację
                let uniqueEstimate = rawSubscribersTotal;
                
                // Zmniejsz o rozsądny współczynnik, jeśli jest wiele grup (aby uwzględnić możliwe duplikaty)
                if (selectedGroups.length > 1) {
                    uniqueEstimate = Math.floor(rawSubscribersTotal * 0.9); // Oszacuj 10% nakładania się
                }
                
                // Oblicz sumę netto jako: szacowane unikalne subskrybenci + dodatkowe emaile - wykluczeni
                const netTotal = Math.max(0, uniqueEstimate - excludedCount) + additionalCount;
                
                updateCountDisplay(rawSubscribersTotal, netTotal, selectedGroups.length, additionalCount, excludedCount);
                
                // Aktualizuj podsumowanie
                summaryRecipients.textContent = netTotal;
            });
    }
    
    /**
     * Aktualizuj elementy wyświetlania liczb
     */
    function updateCountDisplay(rawTotal, netTotal, groupCount, additionalCount, excludedCount) {
        // Ustaw surową łączną liczbę (prosta suma wszystkich subskrybentów we wszystkich grupach)
        document.getElementById('raw-subscriber-count').textContent = rawTotal;
        
        // Ustaw inne liczby
        document.getElementById('selected-groups-count').textContent = groupCount;
        document.getElementById('additional-emails-count').textContent = additionalCount;
        document.getElementById('excluded-count').textContent = excludedCount;
        
        // Aktualizuj znacznik z sumą netto (rzeczywiści odbiorcy ze zgodą)
        document.getElementById('total-recipients-badge').textContent = `${netTotal} unikalnych odbiorców ze zgodą`;
    }
    
    /**
     * Aktualizuj podsumowanie dla ostatniego kroku
     */
    function updateSummary() {
        // Temat
        const subject = subjectInput.value.trim();
        summarySubject.textContent = subject || '-';
        
        // Opcje dostarczania już zaktualizowane przez updateDeliveryOptions()
        
        // Liczba odbiorców jest aktualizowana przez updateRecipientsSummary()
        
        // Upewnij się, że opcje dostarczania są zaktualizowane
        updateDeliveryOptions();
    }
    
    /**
     * Inicjalizacja funkcji wyszukiwania
     */
    function initializeSearch() {
        console.log('Inicjalizacja funkcji wyszukiwania');
        
        // Wyszukiwanie grup
        groupSearchInput.addEventListener('input', debounce(function() {
            const searchTerm = this.value.trim();
            console.log('Wyszukiwanie grup:', searchTerm);
            renderGroupsList(searchTerm);
        }, 300));
        
        clearGroupSearchBtn.addEventListener('click', function() {
            groupSearchInput.value = '';
            renderGroupsList();
        });
        
        // Wyszukiwanie subskrybentów
        subscriberSearchInput.addEventListener('input', debounce(function() {
            const searchTerm = this.value.trim();
            renderSubscribersList(searchTerm);
        }, 300));
        
        clearSubscriberSearchBtn.addEventListener('click', function() {
            subscriberSearchInput.value = '';
            renderSubscribersList();
        });
    }
    
    // Funkcja narzędziowa do debounce
    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), wait);
        };
    }
    
    // Inicjalizacja wszystkiego
    initWizard();
    loadGroups();
    updateDeliveryOptions();
    updateRecipientsSummary();
    initializeSearch();
    
    // Skonfiguruj nasłuchiwacze zdarzeń dla przycisków radio
    sendNowRadio.addEventListener('change', updateDeliveryOptions);
    scheduleRadio.addEventListener('change', updateDeliveryOptions);
    
    // Skonfiguruj nasłuchiwacz zdarzeń dla pola tekstowego dodatkowych emaili
    additionalEmailsTextarea.addEventListener('input', debounce(function() {
        updateRecipientsSummary();
    }, 500));
    
    // Skonfiguruj nasłuchiwacze zdarzeń dla zaplanowanej daty i godziny
    const scheduleDateInput = document.getElementById('schedule_date');
    const scheduleTimeInput = document.getElementById('schedule_time');
    
    if (scheduleDateInput && scheduleTimeInput) {
        const updateScheduledDateTime = function() {
            if (scheduleRadio.checked) {
                const dateValue = scheduleDateInput.value;
                const timeValue = scheduleTimeInput.value;
                
                if (dateValue && timeValue) {
                    summaryScheduleTime.textContent = `${dateValue} o ${timeValue}`;
                } else {
                    summaryScheduleTime.textContent = 'Nie wybrano daty';
                }
            }
        };
        
        scheduleDateInput.addEventListener('change', updateScheduledDateTime);
        scheduleTimeInput.addEventListener('change', updateScheduledDateTime);
        
        // Inicjalizuj bieżącą datą
        const today = new Date();
        const formattedDate = today.toISOString().split('T')[0];
        scheduleDateInput.setAttribute('min', formattedDate);
        scheduleDateInput.value = formattedDate;
    }
    
    // Skonfiguruj nasłuchiwacze zdarzeń dla załączników
    const attachmentInput = document.getElementById('attachment');
    const clearAttachmentsBtn = document.getElementById('clear-attachments');
    const attachmentList = document.getElementById('attachment-list');
    const summaryAttachments = document.getElementById('summary-attachments');
    
    if (attachmentInput && clearAttachmentsBtn && attachmentList) {
        attachmentInput.addEventListener('change', function() {
            // Wyczyść listę
            attachmentList.innerHTML = '';
            
            if (this.files.length > 0) {
                // Sprawdź liczbę plików
                if (this.files.length > 5) {
                    alert('Możesz przesłać maksymalnie 5 plików.');
                    this.value = '';
                    summaryAttachments.textContent = 'Brak';
                    return;
                }
                
                // Sprawdź rozmiary i typy plików
                let validFiles = true;
                const allowedTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'image/jpeg', 'image/png'];
                const fileNames = [];
                
                for (let i = 0; i < this.files.length; i++) {
                    const file = this.files[i];
                    fileNames.push(file.name);
                    
                    // Sprawdź rozmiar pliku (limit 10MB)
                    if (file.size > 10 * 1024 * 1024) {
                        alert(`Plik ${file.name} przekracza limit rozmiaru 10MB.`);
                        validFiles = false;
                        break;
                    }
                    
                    // Sprawdź typ pliku
                    if (!allowedTypes.includes(file.type)) {
                        alert(`Plik ${file.name} ma nieobsługiwany typ. Dozwolone są tylko PDF, DOC, DOCX, JPG i PNG.`);
                        validFiles = false;
                        break;
                    }
                    
                    // Dodaj do listy
                    const item = document.createElement('div');
                    item.className = 'list-group-item d-flex justify-content-between align-items-center py-2';
                    
                    // Ikona oparta na typie pliku
                    let icon = 'fa-file';
                    if (file.type === 'application/pdf') icon = 'fa-file-pdf';
                    else if (file.type.includes('word')) icon = 'fa-file-word';
                    else if (file.type.includes('image')) icon = 'fa-file-image';
                    
                    // Informacje o pliku z ikoną
                    const fileInfo = document.createElement('div');
                    fileInfo.innerHTML = `<i class="fas ${icon} me-2"></i>${file.name} <span class="text-muted">(${formatFileSize(file.size)})</span>`;
                    
                    item.appendChild(fileInfo);
                    attachmentList.appendChild(item);
                }
                
                if (!validFiles) {
                    this.value = '';
                    attachmentList.innerHTML = '';
                    summaryAttachments.textContent = 'Brak';
                } else {
                    summaryAttachments.textContent = fileNames.join(', ');
                }
            } else {
                summaryAttachments.textContent = 'Brak';
            }
        });
        
        // Przycisk czyszczenia załączników
        clearAttachmentsBtn.addEventListener('click', function() {
            attachmentInput.value = '';
            attachmentList.innerHTML = '';
            summaryAttachments.textContent = 'Brak';
        });
    }
    
    // Formatuj rozmiar pliku
    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' bajtów';
        else if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        else return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }
    
    // Skonfiguruj uruchamianie kontroli spamu
    const runSpamCheckBtn = document.getElementById('run-spam-check');
    if (runSpamCheckBtn) {
        runSpamCheckBtn.addEventListener('click', function() {
            // Pokaż wskaźnik ładowania
            this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Uruchamianie kontroli spamu...';
            this.disabled = true;
            
            // Symulacja kontroli spamu (w prawdziwej aplikacji, to byłoby wywołanie API)
            setTimeout(() => {
                const spamScoreBar = document.getElementById('spam-score-bar');
                const spamCheckList = document.getElementById('spam-check-list');
                
                // Losowy wynik między 5% i 35%
                const score = Math.floor(Math.random() * 30) + 5;
                
                // Aktualizuj pasek wyniku
                spamScoreBar.style.width = `${score}%`;
                spamScoreBar.textContent = `${score}%`;
                
                // Ustaw kolor na podstawie wyniku
                if (score < 20) {
                    spamScoreBar.className = 'progress-bar bg-success';
                    document.querySelector('.badge').className = 'badge bg-success';
                    document.querySelector('.badge').textContent = 'Niskie ryzyko';
                } else if (score < 50) {
                    spamScoreBar.className = 'progress-bar bg-warning';
                    document.querySelector('.badge').className = 'badge bg-warning';
                    document.querySelector('.badge').textContent = 'Średnie ryzyko';
                } else {
                    spamScoreBar.className = 'progress-bar bg-danger';
                    document.querySelector('.badge').className = 'badge bg-danger';
                    document.querySelector('.badge').textContent = 'Wysokie ryzyko';
                }
                
                // Zresetuj przycisk
                this.innerHTML = '<i class="fas fa-sync-alt me-2"></i> Uruchom kontrolę spamu ponownie';
                this.disabled = false;
            }, 1500);
        });
    }
    
    // Skonfiguruj nasłuchiwacz zdarzeń dla zmian tematu
    if (subjectInput) {
        subjectInput.addEventListener('input', debounce(function() {
            summarySubject.textContent = this.value.trim() || '-';
        }, 300));
    }
    
    // Dodatkowe informacje do debugowania
    console.log('Początkowy stan formularza:');
    console.log('- Element formularza:', form);
    console.log('- Element pola grup:', groupsInput);
    console.log('- Element pola wykluczonych subskrybentów:', excludedSubscribersInput);
    
    // Bezpośrednie sprawdzenie DOM dla elementów formularza
    if (!form) console.error('Element formularza nie znaleziony!');
    if (!groupsInput) console.error('Pole grup nie znalezione!');
    if (!excludedSubscribersInput) console.error('Pole wykluczonych subskrybentów nie znalezione!');
});
</script>
{% endblock %}