{% extends "base.html" %}
{% load static %}

{% block title %}Create Newsletter | XManager{% endblock %}

{% block page_title %}Create Newsletter{% endblock %}

{% block page_actions %}
    <a href="{% url 'newsletter:newsletter_list' %}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-1"></i> Back to Newsletters
    </a>
{% endblock %}

{% block content %}
{% if edit_mode %}
<input type="hidden" name="newsletter_id" value="{{ newsletter.id }}">
{% endif %}
    <div class="card">
        <div class="card-body">
            <!-- Wizard Steps Navigation -->
            <div class="wizard-navigation mb-4">
                <div class="progress" style="height: 3px;">
                    <div class="progress-bar" role="progressbar" style="width: 33%;" aria-valuenow="33" aria-valuemin="0" aria-valuemax="100" id="wizard-progress-bar"></div>
                </div>
                <ul class="nav nav-pills nav-wizard" id="wizardSteps" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="step1-tab" data-bs-toggle="pill" data-bs-target="#step1" type="button" role="tab" aria-controls="step1" aria-selected="true">
                            <span class="wizard-step-icon">1</span>
                            <span class="wizard-step-text">Content</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="step2-tab" data-bs-toggle="pill" data-bs-target="#step2" type="button" role="tab" aria-controls="step2" aria-selected="false">
                            <span class="wizard-step-icon">2</span>
                            <span class="wizard-step-text">Recipients</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="step3-tab" data-bs-toggle="pill" data-bs-target="#step3" type="button" role="tab" aria-controls="step3" aria-selected="false">
                            <span class="wizard-step-icon">3</span>
                            <span class="wizard-step-text">Delivery</span>
                        </button>
                    </li>
                </ul>
            </div>

            <form method="post" id="newsletter-form">
                {% csrf_token %}
                
                {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                        {% for error in form.non_field_errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                {% endif %}
                
                <div class="tab-content" id="wizardTabContent">
                    <!-- Step 1: Content -->
                    <div class="tab-pane fade show active" id="step1" role="tabpanel" aria-labelledby="step1-tab">
                        <h4 class="mb-4">Newsletter Content</h4>
                        
                        <!-- Subject -->
                        <div class="mb-4">
                            <label for="{{ form.subject.id_for_label }}" class="form-label">Subject *</label>
                            {{ form.subject }}
                            {% if form.subject.errors %}
                                <div class="invalid-feedback d-block">{{ form.subject.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <!-- Template -->
                        <div class="mb-4">
                            <label for="{{ form.template.id_for_label }}" class="form-label">Template</label>
                            <select id="{{ form.template.id_for_label }}" name="{{ form.template.html_name }}" class="form-select">
                                <option value="">Default Template</option>
                                {% for template in templates %}
                                    <option value="{{ template.id }}">{{ template.name }}</option>
                                {% endfor %}
                            </select>
                            {% if form.template.errors %}
                                <div class="invalid-feedback d-block">{{ form.template.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <!-- Content -->
                        <div class="mb-4">
                            <label for="{{ form.content.id_for_label }}" class="form-label">Content *</label>
                            {{ form.content }}
                            {% if form.content.errors %}
                                <div class="invalid-feedback d-block">{{ form.content.errors.0 }}</div>
                            {% endif %}
                            <div class="form-text">You can use Markdown or HTML in the content.</div>
                        </div>
                        
                        <!-- Attachments -->
                        <div class="mb-4">
                            <label class="form-label">Attachments</label>
                            <div class="input-group mb-2">
                                <input type="file" class="form-control" id="attachment" name="attachment" multiple>
                                <button class="btn btn-outline-secondary" type="button" id="clear-attachments">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="form-text">Maximum 5 files, 10MB each. Allowed formats: PDF, DOC, DOCX, JPG, PNG</div>
                            <div id="attachment-list" class="list-group mt-2"></div>
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            <button type="button" class="btn btn-outline-secondary" disabled>Previous</button>
                            <button type="button" class="btn btn-primary next-step" data-next="step2">Next: Recipients</button>
                        </div>
                    </div>
                    
                    <!-- Step 2: Recipients -->
                    <div class="tab-pane fade" id="step2" role="tabpanel" aria-labelledby="step2-tab">
                        <h4 class="mb-4">Newsletter Recipients</h4>
                        
                        <div class="row">
                            <!-- Left side: Groups list -->
                            <div class="col-md-5">
                                <div class="mb-4">
                                    <label class="form-label">Subscriber Groups</label>
                                    <div class="input-group mb-2">
                                        <input type="text" class="form-control" id="group-search" placeholder="Search groups...">
                                        <button class="btn btn-outline-secondary" type="button" id="clear-group-search">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                    <div class="border rounded p-2" style="height: 300px; overflow-y: auto;">
                                        <div id="groups-list" class="list-group list-group-flush">
                                            <div class="text-center py-2">
                                                <div class="spinner-border spinner-border-sm" role="status"></div>
                                                <span class="ms-2">Loading groups...</span>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Hidden input to store selected groups -->
                                    <input type="hidden" id="id_subscriber_groups" name="subscriber_groups">
                                </div>
                            </div>
                            
                            <!-- Right side: Subscribers from Selected Groups -->
                            <div class="col-md-7">
                                <div class="mb-4">
                                    <label class="form-label">Subscribers from Selected Groups</label>
                                    <div class="input-group mb-2">
                                        <input type="text" class="form-control" id="subscriber-search" placeholder="Search subscribers...">
                                        <button class="btn btn-outline-secondary" type="button" id="clear-subscriber-search">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                    <div class="border rounded p-2" style="height: 300px; overflow-y: auto;">
                                        <div id="subscribers-list" class="list-group list-group-flush">
                                            <div class="text-center py-2 text-muted">
                                                Select a group to see subscribers
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Hidden input to store excluded subscribers -->
                                    <input type="hidden" id="id_excluded_subscribers" name="excluded_subscribers">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Additional email addresses -->
                        <div class="mb-4">
                            <label for="additional-emails" class="form-label">Additional Email Addresses</label>
                            <textarea class="form-control" id="additional-emails" name="additional_emails" rows="3" 
                                      placeholder="Enter email addresses (one per line or comma-separated)"></textarea>
                            <div class="form-text">These addresses will receive the newsletter even if they're not subscribers</div>
                        </div>
                        
                        <!-- Recipients Summary -->
                        <div class="card my-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">Recipients Summary</h5>
                                <span class="badge bg-primary" id="total-recipients-badge">0 recipients</span>
                            </div>
                            <div class="card-body">
                                <p class="text-muted small mb-3">
                                    <i class="fas fa-info-circle me-1"></i> unique subscribers + additional emails - excluded subscribers
                                </p>
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>Raw Subscriber Count:</span>
                                        <span class="fw-bold" id="raw-subscriber-count">0</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>Selected Groups:</span>
                                        <span id="selected-groups-count">0</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>Additional Emails:</span>
                                        <span id="additional-emails-count">0</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>Excluded Subscribers:</span>
                                        <span id="excluded-count">0</span>
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            <button type="button" class="btn btn-outline-secondary prev-step" data-prev="step1">Previous: Content</button>
                            <button type="button" class="btn btn-primary next-step" data-next="step3">Next: Delivery</button>
                        </div>
                    </div>
                    
                    <!-- Step 3: Delivery -->
                    <div class="tab-pane fade" id="step3" role="tabpanel" aria-labelledby="step3-tab">
                        <h4 class="mb-4">Delivery Options</h4>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <!-- When to send -->
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h5 class="card-title mb-0">When to send</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <div class="btn-group w-100" role="group">
                                                <input type="radio" class="btn-check" name="delivery_option" id="send_now" value="now" checked autocomplete="off">
                                                <label class="btn btn-outline-primary" for="send_now">Send Now</label>
                                                
                                                <input type="radio" class="btn-check" name="delivery_option" id="schedule" value="schedule" autocomplete="off">
                                                <label class="btn btn-outline-primary" for="schedule">Schedule</label>
                                            </div>
                                        </div>
                                        
                                        <div id="schedule-date-container" class="mb-4 d-none">
                                            <label for="schedule_datetime" class="form-label">Scheduled Date and Time</label>
                                            <div class="input-group">
                                                <input type="date" class="form-control" id="schedule_date" name="schedule_date" min="{{ today_date|date:'Y-m-d' }}">
                                                <input type="time" class="form-control" id="schedule_time" name="schedule_time" value="12:00">
                                            </div>
                                            <div class="form-text">Select a future date and time when this newsletter should be sent</div>
                                        </div>
                                        
                                        <!-- Attachments -->
                                        <div class="mb-4">
                                            <label class="form-label">Attachments</label>
                                            <div class="input-group mb-2">
                                                <input type="file" class="form-control" id="attachment" name="attachment" multiple>
                                                <button class="btn btn-outline-secondary" type="button" id="clear-attachments">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                            <div class="form-text">Maximum 5 files, 10MB each. Allowed formats: PDF, DOC, DOCX, JPG, PNG</div>
                                            <div id="attachment-list" class="list-group mt-2"></div>
                                        </div>
                                        
                                        <!-- Hidden fields for form processing -->
                                        <input type="hidden" name="send_now" id="id_send_now" value="true">
                                        <input type="hidden" name="schedule_send" id="id_schedule_send" value="false">
                                        <input type="hidden" name="status" id="id_status" value="draft">
                                    </div>
                                </div>
                                
                                <!-- Delivery settings -->
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h5 class="card-title mb-0">Delivery Settings</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="throttle_rate" class="form-label">Sending rate (emails per minute)</label>
                                            <select class="form-select" id="throttle_rate" name="throttle_rate">
                                                <option value="10">10 emails/minute (recommended)</option>
                                                <option value="20">20 emails/minute</option>
                                                <option value="50">50 emails/minute</option>
                                                <option value="100">100 emails/minute (may trigger spam filters)</option>
                                                <option value="0">No limit (not recommended)</option>
                                            </select>
                                            <div class="form-text">Lower rates improve deliverability</div>
                                        </div>
                                        
                                        <div class="mb-3 form-check">
                                            <input type="checkbox" class="form-check-input" id="add_tracking" name="add_tracking" checked>
                                            <label class="form-check-label" for="add_tracking">Add tracking codes to links</label>
                                            <div class="form-text">Track clicks and opens in the newsletter</div>
                                        </div>
                                        
                                        <div class="mb-3 form-check">
                                            <input type="checkbox" class="form-check-input" id="add_unsubscribe" name="add_unsubscribe" checked>
                                            <label class="form-check-label" for="add_unsubscribe">Add unsubscribe link</label>
                                            <div class="form-text">Required for compliance with anti-spam regulations</div>
                                        </div>
                                        
                                        <div class="mb-3 form-check">
                                            <input type="checkbox" class="form-check-input" id="use_uuid" name="use_uuid" checked>
                                            <label class="form-check-label" for="use_uuid">Add unique identifiers</label>
                                            <div class="form-text">Helps prevent messages from being marked as spam</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <!-- Newsletter Summary -->
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h5 class="card-title mb-0">Newsletter Summary</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="fw-bold">Subject:</label>
                                            <p id="summary-subject">-</p>
                                        </div>
                                        <div class="mb-3">
                                            <label class="fw-bold">Recipients:</label>
                                            <p><span id="summary-recipients">0</span> recipients will receive this newsletter</p>
                                        </div>
                                        <div class="mb-3">
                                            <label class="fw-bold">Delivery:</label>
                                            <p id="summary-delivery">Send immediately</p>
                                        </div>
                                        <div class="mb-3 d-none" id="summary-schedule-container">
                                            <label class="fw-bold">Scheduled for:</label>
                                            <p id="summary-schedule-time">-</p>
                                        </div>
                                        <div class="mb-3">
                                            <label class="fw-bold">Attachments:</label>
                                            <p id="summary-attachments">None</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Anti-spam check -->
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h5 class="card-title mb-0">Spam Check Results</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between mb-3">
                                            <span>Spam score:</span>
                                            <div class="progress flex-grow-1 mx-2" style="height: 20px;">
                                                <div class="progress-bar bg-success" role="progressbar" style="width: 15%;" aria-valuenow="15" aria-valuemin="0" aria-valuemax="100" id="spam-score-bar">15%</div>
                                            </div>
                                            <span class="badge bg-success">Low risk</span>
                                        </div>
                                        
                                        <ul class="list-group list-group-flush" id="spam-check-list">
                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                <span>Subject line not spammy</span>
                                                <i class="fas fa-check-circle text-success"></i>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                <span>Content has good text/image ratio</span>
                                                <i class="fas fa-check-circle text-success"></i>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                <span>Has unsubscribe link</span>
                                                <i class="fas fa-check-circle text-success"></i>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                <span>No excessive capitalization</span>
                                                <i class="fas fa-check-circle text-success"></i>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between align-items-center text-warning">
                                                <span>Content includes potentially spammy words</span>
                                                <i class="fas fa-exclamation-triangle text-warning"></i>
                                            </li>
                                        </ul>
                                        <button type="button" id="run-spam-check" class="btn btn-sm btn-outline-primary mt-3 w-100">
                                            <i class="fas fa-sync-alt me-2"></i> Run spam check again
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            <button type="button" class="btn btn-outline-secondary prev-step" data-prev="step2">Previous: Recipients</button>
                            <div>
                                <button type="submit" name="save_as_draft" class="btn btn-outline-secondary me-1">Save as Draft</button>
                                <button type="submit" name="send_test" class="btn btn-outline-primary me-1">Send Test Email</button>
                                <button type="submit" name="save_and_preview" class="btn btn-outline-primary me-1">Preview</button>
                                <button type="submit" name="save_and_send" class="btn btn-primary">Send Newsletter</button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
{% endblock %}

{% block extra_css %}
<style>
/* Wizard navigation styling */
.nav-wizard {
    display: flex;
    justify-content: space-between;
    margin-top: -1.5rem;
    position: relative;
    z-index: 1;
}

.nav-wizard .nav-item {
    flex: 1;
    text-align: center;
}

.nav-wizard .nav-link {
    padding: 0;
    margin-top: 0;
    background-color: transparent !important;
    color: #6c757d;
}

.nav-wizard .nav-link.active {
    color: #0d6efd;
}

.wizard-step-icon {
    display: inline-flex;
    width: 2.5rem;
    height: 2.5rem;
    background-color: #f8f9fa;
    border: 2px solid #dee2e6;
    border-radius: 50%;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-bottom: 0.5rem;
}

.nav-wizard .nav-link.active .wizard-step-icon {
    background-color: #0d6efd;
    border-color: #0d6efd;
    color: white;
}

.wizard-step-text {
    display: block;
    font-size: 0.875rem;
}

/* Badge styling for consent */
.badge-active {
    background-color: #198754;
    color: white;
}

.badge-inactive {
    background-color: #dc3545;
    color: white;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
/**
 * Newsletter Form Wizard
 */
document.addEventListener('DOMContentLoaded', function() {
    console.log('Newsletter wizard script loaded');

    // Element references
    const form = document.getElementById('newsletter-form');
    const wizardTabs = document.querySelectorAll('#wizardSteps .nav-link');
    const wizardSteps = document.querySelectorAll('.tab-pane');
    const progressBar = document.getElementById('wizard-progress-bar');
    const nextButtons = document.querySelectorAll('.next-step');
    const prevButtons = document.querySelectorAll('.prev-step');
    
    // Form elements references
    const sendNowRadio = document.getElementById('send_now');
    const scheduleRadio = document.getElementById('schedule');
    const scheduleDateContainer = document.getElementById('schedule-date-container');
    const sendNowInput = document.getElementById('id_send_now');
    const scheduleInput = document.getElementById('id_schedule_send');
    const statusInput = document.getElementById('id_status');
    const subjectInput = document.getElementById('{{ form.subject.id_for_label }}');
    
    // Groups and subscribers elements
    const groupSearchInput = document.getElementById('group-search');
    const clearGroupSearchBtn = document.getElementById('clear-group-search');
    const groupsList = document.getElementById('groups-list');
    const groupsInput = document.getElementById('id_subscriber_groups');
    
    const subscriberSearchInput = document.getElementById('subscriber-search');
    const clearSubscriberSearchBtn = document.getElementById('clear-subscriber-search');
    const subscribersList = document.getElementById('subscribers-list');
    const excludedSubscribersInput = document.getElementById('id_excluded_subscribers');
    
    const additionalEmailsTextarea = document.getElementById('additional-emails');
    
    // Summary elements
    const summarySubject = document.getElementById('summary-subject');
    const summaryRecipients = document.getElementById('summary-recipients');
    const summaryDelivery = document.getElementById('summary-delivery');
    const summaryScheduleContainer = document.getElementById('summary-schedule-container');
    const summaryScheduleTime = document.getElementById('summary-schedule-time');
    
    // Data storage
    let allGroups = [];
    let selectedGroups = [];
    let allSubscribers = [];
    let excludedSubscribers = [];
    let currentStep = 0;
    
    /**
     * Initialize wizard navigation
     */
    function initWizard() {
        // Set up event listeners for wizard tabs
        wizardTabs.forEach((tab, index) => {
            tab.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Only allow navigating to steps that have been seen
                if (index <= currentStep) {
                    activateStep(index);
                }
            });
        });
        
        // Set up next buttons
        nextButtons.forEach(button => {
            button.addEventListener('click', function() {
                const nextStep = this.getAttribute('data-next');
                
                // Validate current step before proceeding
                if (validateCurrentStep()) {
                    // Go to next step
                    const nextIndex = Array.from(wizardSteps).findIndex(step => step.id === nextStep);
                    if (nextIndex > currentStep) {
                        currentStep = nextIndex;
                    }
                    activateStep(nextIndex);
                    
                    // Update summary if going to step 3
                    if (nextStep === 'step3') {
                        updateSummary();
                    }
                }
            });
        });
        
        // Set up previous buttons
        prevButtons.forEach(button => {
            button.addEventListener('click', function() {
                const prevStep = this.getAttribute('data-prev');
                const prevIndex = Array.from(wizardSteps).findIndex(step => step.id === prevStep);
                activateStep(prevIndex);
            });
        });
    }
    
    /**
     * Activate a specific step
     */
    function activateStep(stepIndex) {
        // Update tabs
        wizardTabs.forEach((tab, index) => {
            if (index === stepIndex) {
                tab.classList.add('active');
                tab.setAttribute('aria-selected', 'true');
            } else {
                tab.classList.remove('active');
                tab.setAttribute('aria-selected', 'false');
            }
        });
        
        // Update content panes
        wizardSteps.forEach((step, index) => {
            if (index === stepIndex) {
                step.classList.add('show', 'active');
            } else {
                step.classList.remove('show', 'active');
            }
        });
        
        // Update progress bar
        const progress = Math.floor((stepIndex / (wizardTabs.length - 1)) * 100);
        progressBar.style.width = `${progress}%`;
        progressBar.setAttribute('aria-valuenow', progress);
    }
    
    /**
     * Validate the current step
     */
    function validateCurrentStep() {
        const activeStep = document.querySelector('.tab-pane.active');
        
        if (activeStep.id === 'step1') {
            // Validate content step
            const subject = subjectInput.value.trim();
            const content = document.querySelector('textarea[name="content"]').value.trim();
            
            if (!subject) {
                alert('Please enter a subject for the newsletter.');
                subjectInput.focus();
                return false;
            }
            
            if (!content) {
                alert('Please enter content for the newsletter.');
                document.querySelector('textarea[name="content"]').focus();
                return false;
            }
            
            return true;
        }
        else if (activeStep.id === 'step2') {
            // Validate recipients step
            const hasGroups = selectedGroups.length > 0;
            const hasEmails = additionalEmailsTextarea && additionalEmailsTextarea.value.trim().length > 0;
            
            if (!hasGroups && !hasEmails) {
                alert('You must select at least one recipient group or provide additional email addresses.');
                return false;
            }
            
            return true;
        }
        
        return true;
    }
    
    /**
     * Properly handle form submission
     */
    if (form) {
        form.addEventListener('submit', function(e) {
            // Check which button was clicked
            const isDraft = e.submitter && e.submitter.name === 'save_as_draft';
            const isPreview = e.submitter && e.submitter.name === 'save_and_preview';
            const isTestEmail = e.submitter && e.submitter.name === 'send_test';
            const isSend = e.submitter && e.submitter.name === 'save_and_send';
            
            // For test emails, prompt for the test email address
            if (isTestEmail) {
                e.preventDefault();
                
                // Create a modal to get test email
                const modal = document.createElement('div');
                modal.className = 'modal fade';
                modal.id = 'testEmailModal';
                modal.tabIndex = '-1';
                modal.innerHTML = `
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Send Test Email</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label for="test_email" class="form-label">Send test to email address:</label>
                                    <input type="email" class="form-control" id="test_email" required>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" id="send-test-btn">Send Test</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Show the modal
                const testEmailModal = new bootstrap.Modal(document.getElementById('testEmailModal'));
                testEmailModal.show();
                
                // Handle the test email submission
                document.getElementById('send-test-btn').addEventListener('click', function() {
                    const testEmail = document.getElementById('test_email').value.trim();
                    
                    if (!testEmail || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(testEmail)) {
                        alert('Please enter a valid email address.');
                        return;
                    }
                    
                    // Add the test email to the form
                    const testEmailInput = document.createElement('input');
                    testEmailInput.type = 'hidden';
                    testEmailInput.name = 'test_email';
                    testEmailInput.value = testEmail;
                    form.appendChild(testEmailInput);
                    
                    // Add a flag to indicate this is a test email
                    const isTestInput = document.createElement('input');
                    isTestInput.type = 'hidden';
                    isTestInput.name = 'is_test';
                    isTestInput.value = 'true';
                    form.appendChild(isTestInput);
                    
                    // Hide the modal
                    testEmailModal.hide();
                    
                    // Submit the form
                    form.submit();
                });
                
                // Don't continue with the normal form submission
                return false;
            }
            
            // For non-drafts, validate all steps
            if (!isDraft && !isPreview) {
                for (let i = 0; i < wizardSteps.length; i++) {
                    const stepIndex = i;
                    activateStep(stepIndex);
                    if (!validateCurrentStep()) {
                        e.preventDefault();
                        return false;
                    }
                }
            }
            
            // Clean up existing fields to avoid duplicates
            form.querySelectorAll('input[name="subscriber_groups"]').forEach(field => field.remove());
            
            // Get all checked groups
            const checkedGroups = document.querySelectorAll('.group-checkbox:checked');
            
            // Add a hidden field for each selected group
            checkedGroups.forEach(checkbox => {
                const field = document.createElement('input');
                field.type = 'hidden';
                field.name = 'subscriber_groups';
                field.value = checkbox.value;
                form.appendChild(field);
                console.log('Added group ID to form:', checkbox.value);
            });
            
            // Add hidden field for excluded subscribers
            if (excludedSubscribers.length > 0) {
                form.querySelectorAll('input[name="excluded_subscribers"]').forEach(field => field.remove());
                const excludedField = document.createElement('input');
                excludedField.type = 'hidden';
                excludedField.name = 'excluded_subscribers';
                excludedField.value = excludedSubscribers.join(',');
                form.appendChild(excludedField);
            }
            
            // Add appropriate flags based on button clicked
            if (isPreview) {
                const previewInput = document.createElement('input');
                previewInput.type = 'hidden';
                previewInput.name = 'save_and_preview';
                previewInput.value = 'true';
                form.appendChild(previewInput);
            } else if (isDraft) {
                const draftInput = document.createElement('input');
                draftInput.type = 'hidden';
                draftInput.name = 'is_draft';
                draftInput.value = 'true';
                form.appendChild(draftInput);
            } else if (isSend) {
                const sendInput = document.createElement('input');
                sendInput.type = 'hidden';
                sendInput.name = 'send_newsletter';
                sendInput.value = 'true';
                form.appendChild(sendInput);
                
                // Confirm before sending to real recipients
                if (!confirm(`Are you sure you want to send this newsletter to ${document.getElementById('summary-recipients').textContent} recipients?`)) {
                    e.preventDefault();
                    return false;
                }
            }
            
            return true;
        });
    }
    
    /**
     * Load all subscriber groups from API
     */
    function loadGroups() {
        console.log('Loading groups...');
        groupsList.innerHTML = '<div class="text-center py-2"><div class="spinner-border spinner-border-sm" role="status"></div><span class="ms-2">Loading groups...</span></div>';
        
        fetch('/newsletter/api/subscriber-groups/')
            .then(response => response.json())
            .then(data => {
                console.log('Groups loaded:', data);
                allGroups = data;
                renderGroupsList();
            })
            .catch(error => {
                console.error('Error loading groups:', error);
                groupsList.innerHTML = '<div class="text-center py-2 text-danger">Error loading groups</div>';
            });
    }
    
    /**
     * Render groups list with checkboxes
     */
    function renderGroupsList(searchTerm = '') {
        console.log('Rendering groups list. Search term:', searchTerm);
        console.log('Selected groups before rendering:', selectedGroups);
        
        // Save current checked state
        const checkedGroupIds = [];
        document.querySelectorAll('.group-checkbox:checked').forEach(cb => {
            checkedGroupIds.push(parseInt(cb.value));
        });
        console.log('Currently checked group IDs:', checkedGroupIds);
        
        // Merge with selectedGroups to maintain selections
        selectedGroups = [...new Set([...selectedGroups, ...checkedGroupIds])];
        console.log('Updated selected groups:', selectedGroups);
        
        // Clear and rebuild the list
        groupsList.innerHTML = '';
        
        if (allGroups.length === 0) {
            groupsList.innerHTML = '<div class="text-center py-2 text-muted">No groups available</div>';
            return;
        }
        
        // Filter by search term if provided
        const filteredGroups = searchTerm 
            ? allGroups.filter(group => group.group_name.toLowerCase().includes(searchTerm.toLowerCase()))
            : allGroups;
        
        if (filteredGroups.length === 0) {
            groupsList.innerHTML = '<div class="text-center py-2 text-muted">No groups match your search</div>';
            return;
        }
        
        // Create group items with checkboxes
        filteredGroups.forEach(group => {
            const item = document.createElement('div');
            item.className = 'list-group-item d-flex justify-content-between align-items-center p-2';
            
            // Checkbox
            const checkboxDiv = document.createElement('div');
            checkboxDiv.className = 'form-check';
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'form-check-input group-checkbox';
            checkbox.id = `group-${group.id}`;
            checkbox.value = group.id;
            
            // Check if this group is selected
            checkbox.checked = selectedGroups.includes(parseInt(group.id)) || selectedGroups.includes(group.id);
            
            checkbox.addEventListener('change', function() {
                handleGroupSelection(parseInt(group.id), this.checked);
            });
            
            const label = document.createElement('label');
            label.className = 'form-check-label';
            label.htmlFor = `group-${group.id}`;
            label.textContent = group.group_name;
            
            checkboxDiv.appendChild(checkbox);
            checkboxDiv.appendChild(label);
            
            // Subscriber count badge
            const badge = document.createElement('span');
            badge.className = 'badge bg-primary rounded-pill';
            badge.textContent = group.subscriber_count || 0;
            
            item.appendChild(checkboxDiv);
            item.appendChild(badge);
            groupsList.appendChild(item);
        });
        
        // Also update subscriber lists if needed
        if (selectedGroups.length > 0) {
            loadGroupSubscribers();
        }
    }
    
    /**
     * Update all hidden inputs with current values
     */
    function updateHiddenInputs() {
        // Always convert to strings before joining
        const groupIdStrings = selectedGroups.map(id => String(id));
        groupsInput.value = groupIdStrings.join(',');
        
        const excludedIdStrings = excludedSubscribers.map(id => String(id));
        excludedSubscribersInput.value = excludedIdStrings.join(',');
        
        console.log('Updated hidden inputs:');
        console.log('- Groups input value:', groupsInput.value);
        console.log('- Excluded subscribers input value:', excludedSubscribersInput.value);
    }
    
    /**
     * Handle group selection/deselection
     */
    function handleGroupSelection(groupId, isSelected) {
        console.log(`Group ${groupId} ${isSelected ? 'selected' : 'deselected'}`);
        
        if (isSelected) {
            if (!selectedGroups.includes(groupId)) {
                selectedGroups.push(groupId);
                loadGroupSubscribers(groupId);
            }
        } else {
            selectedGroups = selectedGroups.filter(id => id !== groupId);
            
            // If this group was deselected, we need to refresh subscribers list
            // for the remaining selected groups
            if (selectedGroups.length > 0) {
                loadGroupSubscribers();
            } else {
                // If no groups selected, clear subscribers list
                subscribersList.innerHTML = '<div class="text-center py-2 text-muted">Select a group to see subscribers</div>';
                allSubscribers = [];
            }
        }
        
        // Update hidden input
        updateHiddenInputs();
        
        updateRecipientsSummary();
    }
    
    /**
     * Load subscribers for selected groups
     */
    function loadGroupSubscribers(newGroupId = null) {
        // If no groups selected, show message
        if (selectedGroups.length === 0) {
            subscribersList.innerHTML = '<div class="text-center py-2 text-muted">Select a group to see subscribers</div>';
            allSubscribers = [];
            return;
        }
        
        // Show loading
        subscribersList.innerHTML = '<div class="text-center py-2"><div class="spinner-border spinner-border-sm" role="status"></div><span class="ms-2">Loading subscribers...</span></div>';
        
        // Track promises for all group subscriber requests
        const fetchPromises = [];
        const allGroupSubscribers = [];
        
        // Fetch subscribers for each selected group
        selectedGroups.forEach(groupId => {
            const promise = fetch(`/newsletter/api/subscriber-groups/${groupId}/subscribers/`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Error fetching subscribers for group ${groupId}`);
                    }
                    return response.json();
                })
                .then(subscribers => {
                    // Add these subscribers to our collection
                    allGroupSubscribers.push(...subscribers);
                })
                .catch(error => {
                    console.error(error);
                    // Continue with other groups even if one fails
                });
            
            fetchPromises.push(promise);
        });
        
        // Wait for all fetch operations to complete
        Promise.all(fetchPromises)
            .then(() => {
                // Remove duplicates (a subscriber might be in multiple groups)
                const uniqueIds = new Set();
                allSubscribers = allGroupSubscribers.filter(subscriber => {
                    if (uniqueIds.has(subscriber.id)) {
                        return false;
                    }
                    uniqueIds.add(subscriber.id);
                    return true;
                });
                
                renderSubscribersList();
            })
            .catch(error => {
                console.error('Error loading group subscribers:', error);
                subscribersList.innerHTML = '<div class="text-center py-2 text-danger">Error loading subscribers</div>';
            });
    }
    
    /**
     * Render subscribers list with exclude checkboxes and consent status
     */
    function renderSubscribersList(searchTerm = '') {
        subscribersList.innerHTML = '';
        
        if (allSubscribers.length === 0) {
            subscribersList.innerHTML = '<div class="text-center py-2 text-muted">No subscribers in selected groups</div>';
            return;
        }
        
        // Filter by search term if provided
        const filteredSubscribers = searchTerm 
            ? allSubscribers.filter(sub => 
                sub.email.toLowerCase().includes(searchTerm.toLowerCase()) || 
                (sub.first_name && sub.first_name.toLowerCase().includes(searchTerm.toLowerCase())) ||
                (sub.last_name && sub.last_name.toLowerCase().includes(searchTerm.toLowerCase())))
            : allSubscribers;
        
        if (filteredSubscribers.length === 0) {
            subscribersList.innerHTML = '<div class="text-center py-2 text-muted">No subscribers match your search</div>';
            return;
        }
        
        // Optional: Add header for columns
        const header = document.createElement('div');
        header.className = 'list-group-item d-flex justify-content-between align-items-center p-2 bg-light';
        header.innerHTML = `
            <div style="width: 60%;" class="small text-muted">Subscriber</div>
            <div style="width: 20%;" class="small text-muted text-center">Consent</div>
            <div style="width: 20%;" class="small text-muted text-end">Include</div>
        `;
        subscribersList.appendChild(header);
        
        // Create subscriber items with exclude checkboxes and consent status
        filteredSubscribers.forEach(subscriber => {
            const item = document.createElement('div');
            item.className = 'list-group-item d-flex justify-content-between align-items-center p-2';
            
            // Subscriber info
            const infoDiv = document.createElement('div');
            infoDiv.style.width = '60%';
            
            const email = document.createElement('div');
            email.className = 'small fw-bold';
            email.textContent = subscriber.email;
            infoDiv.appendChild(email);
            
            if (subscriber.first_name || subscriber.last_name) {
                const name = document.createElement('div');
                name.className = 'small text-muted';
                name.textContent = `${subscriber.first_name || ''} ${subscriber.last_name || ''}`.trim();
                infoDiv.appendChild(name);
            }
            
            // Consent status
            const consentDiv = document.createElement('div');
            consentDiv.style.width = '20%';
            consentDiv.className = 'text-center';
            
            const hasConsent = subscriber.newsletter_consent === true;
            const consentBadge = document.createElement('span');
            
            if (hasConsent) {
                consentBadge.className = 'badge badge-active';
                consentBadge.innerHTML = '<i class="fas fa-check-circle me-1"></i>Yes';
            } else {
                consentBadge.className = 'badge badge-inactive';
                consentBadge.innerHTML = '<i class="fas fa-times-circle me-1"></i>No';
            }
            
            consentDiv.appendChild(consentBadge);
            
            // Exclude checkbox in its own div
            const excludeDiv = document.createElement('div');
            excludeDiv.style.width = '20%';
            excludeDiv.className = 'text-end';
            
            const formCheck = document.createElement('div');
            formCheck.className = 'form-check form-switch';
            formCheck.style.display = 'inline-block'; // Better alignment
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'form-check-input exclude-checkbox';
            checkbox.id = `exclude-${subscriber.id}`;
            checkbox.value = subscriber.id;
            checkbox.checked = !excludedSubscribers.includes(subscriber.id);
            checkbox.addEventListener('change', function() {
                handleSubscriberExclusion(subscriber.id, !this.checked);
            });
            
            const label = document.createElement('label');
            label.className = 'form-check-label';
            label.htmlFor = `exclude-${subscriber.id}`;
            label.textContent = 'Include';
            
            formCheck.appendChild(checkbox);
            // formCheck.appendChild(label);
            excludeDiv.appendChild(formCheck);
            
            // Add all elements to the item
            item.appendChild(infoDiv);
            item.appendChild(consentDiv);
            item.appendChild(excludeDiv);
            subscribersList.appendChild(item);
        });
    }
    
    /**
     * Handle subscriber exclusion/inclusion
     */
    function handleSubscriberExclusion(subscriberId, isExcluded) {
        if (isExcluded) {
            if (!excludedSubscribers.includes(subscriberId)) {
                excludedSubscribers.push(subscriberId);
            }
        } else {
            excludedSubscribers = excludedSubscribers.filter(id => id !== subscriberId);
        }
        
        // Update hidden input
        updateHiddenInputs();
        
        updateRecipientsSummary();
    }
    
    /**
     * Parse additional emails from textarea
     */
    function parseAdditionalEmails() {
        const text = additionalEmailsTextarea.value.trim();
        if (!text) return [];
        
        // Split by commas or newlines
        const emails = text.split(/[\n,]+/).map(email => email.trim()).filter(email => email);
        
        // Validate emails (basic validation)
        return emails.filter(email => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email));
    }
    
    /**
     * Update delivery options based on radio selection
     */
    function updateDeliveryOptions() {
        if (sendNowRadio.checked) {
            scheduleDateContainer.classList.add('d-none');
            summaryScheduleContainer.classList.add('d-none');
            sendNowInput.value = 'true';
            scheduleInput.value = 'false';
            summaryDelivery.textContent = 'Send immediately';
        } else {
            scheduleDateContainer.classList.remove('d-none');
            summaryScheduleContainer.classList.remove('d-none');
            sendNowInput.value = 'false';
            scheduleInput.value = 'true';
            summaryDelivery.textContent = 'Scheduled delivery';
            
            // Update schedule time in summary
            const scheduleDateInput = document.getElementById('schedule_date');
            const scheduleTimeInput = document.getElementById('schedule_time');
            
            if (scheduleDateInput && scheduleTimeInput && scheduleDateInput.value && scheduleTimeInput.value) {
                summaryScheduleTime.textContent = `${scheduleDateInput.value} at ${scheduleTimeInput.value}`;
            } else {
                summaryScheduleTime.textContent = 'No date selected';
            }
        }
        
        // Always set status to draft initially
        statusInput.value = 'draft';
    }
    
    /**
     * Update recipients summary
     */
    function updateRecipientsSummary() {
        // Get count of additional emails
        const additionalEmails = parseAdditionalEmails();
        const additionalCount = additionalEmails.length;
        
        // Calculate raw total of subscribers in all selected groups (without deduplication)
        let rawSubscribersTotal = 0;
        selectedGroups.forEach(groupId => {
            const group = allGroups.find(g => g.id == groupId);
            if (group && group.subscriber_count) {
                rawSubscribersTotal += group.subscriber_count;
            }
        });
        
        // Show loading state
        document.getElementById('total-recipients-badge').textContent = 'Calculating unique recipients with consent...';
        
        // Build query parameters
        const params = new URLSearchParams();
        
        // Add selected group IDs - convert to strings
        selectedGroups.forEach(id => params.append('group_ids', String(id)));
        
        // Log query parameters
        console.log('Query parameters for count API:', params.toString());
        
        // Make API request to get deduplicated count
        fetch(`/newsletter/api/recipients/count/?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                console.log('Recipients count API response:', data);
                const groupCount = selectedGroups.length;
                const excludedCount = excludedSubscribers.length;
                
                // Get unique subscriber count from API (which should NOT include exclusions yet)
                const uniqueSubscribers = data.total_unique || 0;
                
                // Calculate final recipient count: unique subscribers + additional - excluded
                const netTotalCount = uniqueSubscribers + additionalCount - excludedCount;
                
                // Update display with the counts
                updateCountDisplay(rawSubscribersTotal, netTotalCount, groupCount, additionalCount, excludedCount);
                
                // Update summary
                summaryRecipients.textContent = netTotalCount;
            })
            .catch(error => {
                console.error('Error calculating recipients:', error);
                
                // Fallback calculation if API fails:
                // Calculate approximate unique count by estimating deduplication
                let uniqueEstimate = rawSubscribersTotal;
                
                // Reduce by a reasonable factor if multiple groups (to account for possible duplicates)
                if (selectedGroups.length > 1) {
                    uniqueEstimate = Math.floor(rawSubscribersTotal * 0.9); // Estimate 10% overlap
                }
                
                // Calculate net total as: estimated unique subscribers + additional emails - excluded
                const netTotal = Math.max(0, uniqueEstimate - excludedCount) + additionalCount;
                
                updateCountDisplay(rawSubscribersTotal, netTotal, selectedGroups.length, additionalCount, excludedCount);
                
                // Update summary
                summaryRecipients.textContent = netTotal;
            });
    }
    
    /**
     * Update count display elements
     */
    function updateCountDisplay(rawTotal, netTotal, groupCount, additionalCount, excludedCount) {
        // Set the raw total count (simple sum of all subscribers in all groups)
        document.getElementById('raw-subscriber-count').textContent = rawTotal;
        
        // Set other counts
        document.getElementById('selected-groups-count').textContent = groupCount;
        document.getElementById('additional-emails-count').textContent = additionalCount;
        document.getElementById('excluded-count').textContent = excludedCount;
        
        // Update the badge with net total (actual recipients with consent)
        document.getElementById('total-recipients-badge').textContent = `${netTotal} unique recipients with consent`;
    }
    
    /**
     * Update summary for final step
     */
    function updateSummary() {
        // Subject
        const subject = subjectInput.value.trim();
        summarySubject.textContent = subject || '-';
        
        // Delivery options already updated by updateDeliveryOptions()
        
        // Recipients count is updated by updateRecipientsSummary()
        
        // Make sure delivery options are updated
        updateDeliveryOptions();
    }
    
    /**
     * Initialize the search functionality
     */
    function initializeSearch() {
        console.log('Initializing search functionality');
        
        // Group search
        groupSearchInput.addEventListener('input', debounce(function() {
            const searchTerm = this.value.trim();
            console.log('Searching groups:', searchTerm);
            renderGroupsList(searchTerm);
        }, 300));
        
        clearGroupSearchBtn.addEventListener('click', function() {
            groupSearchInput.value = '';
            renderGroupsList();
        });
        
        // Subscriber search
        subscriberSearchInput.addEventListener('input', debounce(function() {
            const searchTerm = this.value.trim();
            renderSubscribersList(searchTerm);
        }, 300));
        
        clearSubscriberSearchBtn.addEventListener('click', function() {
            subscriberSearchInput.value = '';
            renderSubscribersList();
        });
    }
    
    // Utility function for debouncing
    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), wait);
        };
    }
    
    // Initialize everything
    initWizard();
    loadGroups();
    updateDeliveryOptions();
    updateRecipientsSummary();
    initializeSearch();
    
    // Set up event listeners for radio buttons
    sendNowRadio.addEventListener('change', updateDeliveryOptions);
    scheduleRadio.addEventListener('change', updateDeliveryOptions);
    
    // Set up event listener for additional emails textarea
    additionalEmailsTextarea.addEventListener('input', debounce(function() {
        updateRecipientsSummary();
    }, 500));
    
    // Set up event listeners for scheduled date and time
    const scheduleDateInput = document.getElementById('schedule_date');
    const scheduleTimeInput = document.getElementById('schedule_time');
    
    if (scheduleDateInput && scheduleTimeInput) {
        const updateScheduledDateTime = function() {
            if (scheduleRadio.checked) {
                const dateValue = scheduleDateInput.value;
                const timeValue = scheduleTimeInput.value;
                
                if (dateValue && timeValue) {
                    summaryScheduleTime.textContent = `${dateValue} at ${timeValue}`;
                } else {
                    summaryScheduleTime.textContent = 'No date selected';
                }
            }
        };
        
        scheduleDateInput.addEventListener('change', updateScheduledDateTime);
        scheduleTimeInput.addEventListener('change', updateScheduledDateTime);
        
        // Initialize with current date
        const today = new Date();
        const formattedDate = today.toISOString().split('T')[0];
        scheduleDateInput.setAttribute('min', formattedDate);
        scheduleDateInput.value = formattedDate;
    }
    
    // Set up event listeners for attachments
    const attachmentInput = document.getElementById('attachment');
    const clearAttachmentsBtn = document.getElementById('clear-attachments');
    const attachmentList = document.getElementById('attachment-list');
    const summaryAttachments = document.getElementById('summary-attachments');
    
    if (attachmentInput && clearAttachmentsBtn && attachmentList) {
        attachmentInput.addEventListener('change', function() {
            // Clear the list
            attachmentList.innerHTML = '';
            
            if (this.files.length > 0) {
                // Check file count
                if (this.files.length > 5) {
                    alert('You can upload a maximum of 5 files.');
                    this.value = '';
                    summaryAttachments.textContent = 'None';
                    return;
                }
                
                // Check file sizes and types
                let validFiles = true;
                const allowedTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'image/jpeg', 'image/png'];
                const fileNames = [];
                
                for (let i = 0; i < this.files.length; i++) {
                    const file = this.files[i];
                    fileNames.push(file.name);
                    
                    // Check file size (10MB limit)
                    if (file.size > 10 * 1024 * 1024) {
                        alert(`File ${file.name} exceeds the 10MB size limit.`);
                        validFiles = false;
                        break;
                    }
                    
                    // Check file type
                    if (!allowedTypes.includes(file.type)) {
                        alert(`File ${file.name} has an unsupported type. Only PDF, DOC, DOCX, JPG, and PNG are allowed.`);
                        validFiles = false;
                        break;
                    }
                    
                    // Add to the list
                    const item = document.createElement('div');
                    item.className = 'list-group-item d-flex justify-content-between align-items-center py-2';
                    
                    // Icon based on file type
                    let icon = 'fa-file';
                    if (file.type === 'application/pdf') icon = 'fa-file-pdf';
                    else if (file.type.includes('word')) icon = 'fa-file-word';
                    else if (file.type.includes('image')) icon = 'fa-file-image';
                    
                    // File info with icon
                    const fileInfo = document.createElement('div');
                    fileInfo.innerHTML = `<i class="fas ${icon} me-2"></i>${file.name} <span class="text-muted">(${formatFileSize(file.size)})</span>`;
                    
                    item.appendChild(fileInfo);
                    attachmentList.appendChild(item);
                }
                
                if (!validFiles) {
                    this.value = '';
                    attachmentList.innerHTML = '';
                    summaryAttachments.textContent = 'None';
                } else {
                    summaryAttachments.textContent = fileNames.join(', ');
                }
            } else {
                summaryAttachments.textContent = 'None';
            }
        });
        
        // Clear attachments button
        clearAttachmentsBtn.addEventListener('click', function() {
            attachmentInput.value = '';
            attachmentList.innerHTML = '';
            summaryAttachments.textContent = 'None';
        });
    }
    
    // Format file size
    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' bytes';
        else if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        else return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }
    
    // Set up spam check runner
    const runSpamCheckBtn = document.getElementById('run-spam-check');
    if (runSpamCheckBtn) {
        runSpamCheckBtn.addEventListener('click', function() {
            // Show loading indicator
            this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Running spam check...';
            this.disabled = true;
            
            // Simulate spam check (in a real app, this would be an API call)
            setTimeout(() => {
                const spamScoreBar = document.getElementById('spam-score-bar');
                const spamCheckList = document.getElementById('spam-check-list');
                
                // Random score between 5% and 35%
                const score = Math.floor(Math.random() * 30) + 5;
                
                // Update score bar
                spamScoreBar.style.width = `${score}%`;
                spamScoreBar.textContent = `${score}%`;
                
                // Set color based on score
                if (score < 20) {
                    spamScoreBar.className = 'progress-bar bg-success';
                    document.querySelector('.badge').className = 'badge bg-success';
                    document.querySelector('.badge').textContent = 'Low risk';
                } else if (score < 50) {
                    spamScoreBar.className = 'progress-bar bg-warning';
                    document.querySelector('.badge').className = 'badge bg-warning';
                    document.querySelector('.badge').textContent = 'Medium risk';
                } else {
                    spamScoreBar.className = 'progress-bar bg-danger';
                    document.querySelector('.badge').className = 'badge bg-danger';
                    document.querySelector('.badge').textContent = 'High risk';
                }
                
                // Reset button
                this.innerHTML = '<i class="fas fa-sync-alt me-2"></i> Run spam check again';
                this.disabled = false;
            }, 1500);
        });
    }
    
    // Set up event listener for subject changes
    if (subjectInput) {
        subjectInput.addEventListener('input', debounce(function() {
            summarySubject.textContent = this.value.trim() || '-';
        }, 300));
    }
    
    // Additional debugging info
    console.log('Initial form state:');
    console.log('- Form element:', form);
    console.log('- Groups input element:', groupsInput);
    console.log('- Excluded subscribers input element:', excludedSubscribersInput);
    
    // Direct DOM check for form elements
    if (!form) console.error('Form element not found!');
    if (!groupsInput) console.error('Groups input not found!');
    if (!excludedSubscribersInput) console.error('Excluded subscribers input not found!');
});
</script>
{% endblock %}