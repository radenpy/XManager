{% extends "base.html" %}
{% load static %}

{% block title %}Edytuj partnera: {{ partner.name }} | XManager{% endblock %}

{% block page_title %}Edytuj partnera: {{ partner.name }}{% endblock %}

{% block page_actions %}
    <a href="{% url 'partner:partner_list' %}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-1"></i> Powrót do listy
    </a>
{% endblock %}

{% block content %}
    <div class="card">
        <div class="card-body">
            <form method="post" action="{% url 'partner:partner_update' partner.pk %}" id="partnerForm">
                {% csrf_token %}
                
                {% if form.errors %}
                <div class="alert alert-danger">
                    <h5 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i>Błędy formularza:</h5>
                    <ul class="mb-0">
                        {% for field, errors in form.errors.items %}
                            {% for error in errors %}
                                <li>{{ field }}: {{ error }}</li>
                            {% endfor %}
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
                
                <!-- Tabs for form sections -->
                <ul class="nav nav-tabs mb-3" id="partnerFormTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="main-data-tab" data-bs-toggle="tab" data-bs-target="#main-data" type="button" role="tab" aria-controls="main-data" aria-selected="true">
                            <i class="fas fa-info-circle me-1"></i> Dane podstawowe
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="address-tab" data-bs-toggle="tab" data-bs-target="#address" type="button" role="tab" aria-controls="address" aria-selected="false">
                            <i class="fas fa-map-marker-alt me-1"></i> Adres
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="contacts-tab" data-bs-toggle="tab" data-bs-target="#contacts" type="button" role="tab" aria-controls="contacts" aria-selected="false">
                            <i class="fas fa-envelope me-1"></i> Kontakty e-mail
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="vat-status-tab" data-bs-toggle="tab" data-bs-target="#vat-status" type="button" role="tab" aria-controls="vat-status" aria-selected="false">
                            <i class="fas fa-check-circle me-1"></i> Status VAT
                        </button>
                    </li>
                </ul>
                
                <!-- Tab content -->
                <div class="tab-content" id="partnerFormTabContent">
                    <!-- Main data tab -->
                    <div class="tab-pane fade show active" id="main-data" role="tabpanel" aria-labelledby="main-data-tab">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="{{ form.country.id_for_label }}" class="form-label">Kraj</label>
                                <div class="dropdown">
                                    <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start" type="button" id="countryDropdownButton" data-bs-toggle="dropdown" aria-expanded="false">
                                        {% if form.country.value %}
                                            {% for code, name in countries %}
                                                {% if code == form.country.value %}{{ name }}{% endif %}
                                            {% endfor %}
                                        {% else %}
                                            Wybierz kraj
                                        {% endif %}
                                    </button>
                                    <input type="hidden" name="country" id="{{ form.country.id_for_label }}" value="{{ form.country.value|default:'' }}" required>
                                    <ul class="dropdown-menu country-dropdown-menu w-100" aria-labelledby="countryDropdownButton" style="max-height: 300px; overflow-y: auto;">
                                        <li class="px-2 mb-2">
                                            <input type="text" class="form-control form-control-sm" id="countrySearchInput" placeholder="Szukaj...">
                                        </li>
                                        <div class="country-items">
                                            {% for code, name in countries %}
                                                <li><a class="dropdown-item country-item" href="#" data-code="{{ code }}">{{ name }}</a></li>
                                            {% endfor %}
                                        </div>
                                    </ul>
                                </div>
                                {% if form.country.help_text and not form.country.value %}
                                <div class="form-text">{{ form.country.help_text }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.vat_number.id_for_label }}" class="form-label">Numer VAT</label>
                                <div class="input-group">
                                    <span class="input-group-text country-prefix">{% if form.country.value %}{{ form.country.value }}{% else %}--{% endif %}</span>
                                    <input type="text" name="vat_number" id="{{ form.vat_number.id_for_label }}" class="form-control" value="{{ form.vat_number.value|default:'' }}" placeholder="Wprowadź numer VAT (bez prefiksu kraju)" required>
                                    
                                    <a href="{% url 'partner:verify_vat' partner.pk %}" class="btn btn-primary" id="verifyVATBtn">
                                        <i class="fas fa-sync-alt me-1"></i> Weryfikuj
                                    </a>
                                </div>
                                {% if form.vat_number.help_text and not form.vat_number.value %}
                                <div class="form-text">{{ form.vat_number.help_text }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <label for="{{ form.name.id_for_label }}" class="form-label">Nazwa firmy</label>
                                <input type="text" name="name" id="{{ form.name.id_for_label }}" class="form-control" value="{{ form.name.value|default:'' }}" required>
                            </div>
                            <div class="col-md-4">
                                <label for="{{ form.phone_number.id_for_label }}" class="form-label">Numer telefonu</label>
                                <input type="text" name="phone_number" id="{{ form.phone_number.id_for_label }}" class="form-control" value="{{ form.phone_number.value|default:'' }}">
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label for="{{ form.additional_info.id_for_label }}" class="form-label">Dodatkowe informacje</label>
                                <textarea name="additional_info" id="{{ form.additional_info.id_for_label }}" class="form-control" rows="3">{{ form.additional_info.value|default:'' }}</textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Address tab -->
                    <div class="tab-pane fade" id="address" role="tabpanel" aria-labelledby="address-tab">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="{{ form.city.id_for_label }}" class="form-label">Miasto</label>
                                <input type="text" name="city" id="{{ form.city.id_for_label }}" class="form-control" value="{{ form.city.value|default:'' }}">
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.postal_code.id_for_label }}" class="form-label">Kod pocztowy</label>
                                <input type="text" name="postal_code" id="{{ form.postal_code.id_for_label }}" class="form-control" value="{{ form.postal_code.value|default:'' }}">
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="{{ form.street_name.id_for_label }}" class="form-label">Ulica</label>
                                <input type="text" name="street_name" id="{{ form.street_name.id_for_label }}" class="form-control" value="{{ form.street_name.value|default:'' }}">
                            </div>
                            <div class="col-md-3">
                                <label for="{{ form.building_number.id_for_label }}" class="form-label">Nr budynku</label>
                                <input type="text" name="building_number" id="{{ form.building_number.id_for_label }}" class="form-control" value="{{ form.building_number.value|default:'' }}">
                            </div>
                            <div class="col-md-3">
                                <label for="{{ form.apartment_number.id_for_label }}" class="form-label">Nr lokalu</label>
                                <input type="text" name="apartment_number" id="{{ form.apartment_number.id_for_label }}" class="form-control" value="{{ form.apartment_number.value|default:'' }}">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Email contacts tab -->
                    <div class="tab-pane fade" id="contacts" role="tabpanel" aria-labelledby="contacts-tab">
                        <div class="mb-3">
                            <label for="id_email_contacts" class="form-label">Powiązane adresy email (maksymalnie 10)</label>
                            <div class="contact-select-container">
                                <div class="input-group mb-2">
                                    <input type="text" id="subscriberSearchInput" class="form-control" placeholder="Wyszukaj po adresie email, imieniu lub nazwisku...">
                                    <button type="button" class="btn btn-outline-secondary" id="clearSubscriberSearch">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <select name="email_contacts" id="id_email_contacts" class="form-control select2-emails" multiple data-placeholder="Wybierz lub dodaj adres email">
                                    {% if form.email_contacts.value %}
                                        {% for subscriber in form.email_contacts.value %}
                                            <option value="{{ subscriber.id }}" selected>{{ subscriber.email }}</option>
                                        {% endfor %}
                                    {% endif %}
                                </select>
                            </div>
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i> Możesz wpisać nowy adres email, aby automatycznie utworzyć nowego subskrybenta.
                            </div>
                            <div id="selectedContactsCounter" class="mt-2 text-end small">
                                <span id="selectedCount">{{ form.email_contacts.value|default:"0"|length }}</span> z maksymalnie 10 kontaktów
                            </div>
                        </div>
                    </div>
                    
                    <!-- VAT Status tab (only for edit) -->
                    <div class="tab-pane fade" id="vat-status" role="tabpanel" aria-labelledby="vat-status-tab">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="card border-0 bg-light">
                                    <div class="card-body">
                                        <h6 class="card-subtitle mb-2">Status weryfikacji</h6>
                                        <div class="d-flex align-items-center mb-2">
                                            <span class="me-2">Status:</span>
                                            {% if partner.is_verified %}
                                                <span class="badge bg-success">Aktywny</span>
                                            {% else %}
                                                <span class="badge bg-warning">Nieaktywny</span>
                                            {% endif %}
                                        </div>
                                        <p class="mb-1">
                                            <strong>Numer VAT:</strong><br>
                                            {{ partner.get_full_vat_number }}
                                        </p>
                                        <p class="mb-1">
                                            <strong>Data weryfikacji:</strong><br>
                                            {% if partner.verification_date %}
                                                {{ partner.verification_date|date:"d.m.Y H:i" }}
                                            {% else %}
                                                <span class="text-muted">Brak danych</span>
                                            {% endif %}
                                        </p>
                                        <p class="mb-1">
                                            <strong>ID weryfikacji:</strong><br>
                                            {% if partner.verification_id %}
                                                <code class="small">{{ partner.verification_id }}</code>
                                            {% else %}
                                                <span class="text-muted">Brak danych</span>
                                            {% endif %}
                                        </p>
                                        
                                        <div class="mt-3">
                                            <a href="{% url 'partner:verify_vat' partner.pk %}" class="btn btn-sm btn-primary w-100">
                                                <i class="fas fa-sync-alt me-1"></i> Weryfikuj ponownie
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <h6 class="mb-3">Historia weryfikacji</h6>
                                {% if verification_history %}
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover">
                                        <thead>
                                            <tr>
                                                <th>Data</th>
                                                <th>Status</th>
                                                <th>ID weryfikacji</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for entry in verification_history %}
                                            <tr>
                                                <td>{{ entry.verification_date|date:"d.m.Y H:i" }}</td>
                                                <td>
                                                    {% if entry.is_verified %}
                                                    <span class="badge bg-success">Aktywny</span>
                                                    {% else %}
                                                    <span class="badge bg-warning">Nieaktywny</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if entry.verification_id %}
                                                    <code class="small">{{ entry.verification_id|truncatechars:20 }}</code>
                                                    {% else %}
                                                    <span class="text-muted">-</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                {% else %}
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i> Brak historii weryfikacji.
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Form buttons -->
                <div class="d-flex mt-4 border-top pt-3 justify-content-between">
                    <a href="{% url 'partner:partner_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-times me-1"></i> Anuluj
                    </a>
                    
                    <div>
                        <button type="button" class="btn btn-outline-danger me-2" data-bs-toggle="modal" data-bs-target="#deleteConfirmModal">
                            <i class="fas fa-trash me-1"></i> Usuń
                        </button>
                        
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i> Zapisz zmiany
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Delete confirmation modal -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteConfirmModalLabel">Potwierdzenie usunięcia</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-0">Czy na pewno chcesz usunąć firmę <strong>{{ partner.name }}</strong>?</p>
                    <p class="text-danger mb-0">Tej operacji nie można cofnąć.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                    <form action="{% url 'partner:partner_delete' partner.pk %}" method="post">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger">Usuń</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Country dropdown functionality
    const countryDropdown = document.getElementById('countryDropdownButton');
    const countryInput = document.getElementById('{{ form.country.id_for_label }}');
    const countrySearchInput = document.getElementById('countrySearchInput');
    const countryItems = document.querySelectorAll('.country-item');
    
    // Set initial country prefix
    $('.country-prefix').text(countryInput.value || '--');

    // Filter countries when searching
    countrySearchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        
        countryItems.forEach(item => {
            const text = item.textContent.toLowerCase();
            if (text.includes(searchTerm)) {
                item.parentElement.style.display = '';
            } else {
                item.parentElement.style.display = 'none';
            }
        });
    });
    
    // Handle country selection
    countryItems.forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const code = this.getAttribute('data-code');
            const name = this.textContent;
            
            // Update hidden input and dropdown button text
            countryInput.value = code;
            countryDropdown.textContent = name;
            
            // Update country prefix for VAT number
            $('.country-prefix').text(code || '--');
            
            // Hide dropdown
            const dropdownInstance = bootstrap.Dropdown.getInstance(countryDropdown);
            if (dropdownInstance) {
                dropdownInstance.hide();
            }
        });
    });
    
    // Clear search when dropdown is closed
    document.querySelector('.dropdown').addEventListener('hidden.bs.dropdown', function() {
        countrySearchInput.value = '';
        countryItems.forEach(item => {
            item.parentElement.style.display = '';
        });
    });
    
    // Initialize Select2 for subscribers with AJAX
    const emailContactsSelect = $('#id_email_contacts');
    
    emailContactsSelect.select2({
        theme: 'bootstrap-5',
        width: '100%',
        placeholder: 'Wybierz lub dodaj adres email',
        allowClear: true,
        tags: true,
        maximumSelectionLength: 10,
        ajax: {
            url: '/partner/api/subscribers/lookup/',
            dataType: 'json',
            delay: 250,
            data: function(params) {
                return {
                    search: params.term || '',
                    page: params.page || 1
                };
            },
            processResults: function(data, params) {
                params.page = params.page || 1;
                
                return {
                    results: data.results.map(function(item) {
                        return {
                            id: item.id,
                            text: item.email,
                            first_name: item.first_name,
                            last_name: item.last_name
                        };
                    }),
                    pagination: {
                        more: data.has_more
                    }
                };
            },
            cache: true
        },
        templateResult: formatSubscriberResult,
        templateSelection: formatSubscriberSelection,
        createTag: function(params) {
            const term = $.trim(params.term);
            
            if (term === '') {
                return null;
            }
            
            // Check if it's a valid email
            if (!isValidEmail(term)) {
                return null;
            }
            
            return {
                id: term,
                text: term,
                newTag: true
            };
        }
    });
    
    // Clear subscriber search button
    $('#clearSubscriberSearch').on('click', function() {
        $('#subscriberSearchInput').val('');
        // Trigger a search with empty query to reset results
        emailContactsSelect.data('select2').trigger('query', { term: '' });
    });
    
    // Custom search input handler
    $('#subscriberSearchInput').on('input', function() {
        const searchTerm = $(this).val();
        // Trigger the search manually on the Select2
        emailContactsSelect.data('select2').trigger('query', { term: searchTerm });
    });
    
    // Update counter on selection change
    emailContactsSelect.on('change', function(e) {
        const selectedCount = $(this).val() ? $(this).val().length : 0;
        $('#selectedCount').text(selectedCount);
        
        // Highlight in red if too many are selected
        if (selectedCount > 10) {
            $('#selectedContactsCounter').addClass('text-danger');
        } else {
            $('#selectedContactsCounter').removeClass('text-danger');
        }
    });
    
    // Format subscriber dropdown results
    function formatSubscriberResult(subscriber) {
        if (subscriber.loading) {
            return subscriber.text;
        }
        
        if (subscriber.newTag) {
            return $(`
                <div class="new-subscriber-option">
                    <i class="fas fa-plus-circle me-1"></i> 
                    Dodaj nowego subskrybenta: <strong>${subscriber.text}</strong>
                </div>
            `);
        }
        
        const fullName = (subscriber.first_name || subscriber.last_name) 
            ? `${subscriber.first_name || ''} ${subscriber.last_name || ''}`.trim() 
            : '';
            
        return $(`
            <div class="subscriber-result">
                <div><strong>${subscriber.text}</strong></div>
                ${fullName ? `<div class="text-muted small">${fullName}</div>` : ''}
            </div>
        `);
    }
    
    // Format subscriber selection display
    function formatSubscriberSelection(subscriber) {
        // For new tags, just show the email
        if (subscriber.newTag) {
            return subscriber.text;
        }
        
        // For existing subscribers, show email and name if available
        const fullName = (subscriber.first_name || subscriber.last_name) 
            ? `${subscriber.first_name || ''} ${subscriber.last_name || ''}`.trim() 
            : '';
            
        return fullName ? `${subscriber.text} (${fullName})` : subscriber.text;
    }
    
    // Email validation function
    function isValidEmail(email) {
        const regex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
        return regex.test(email);
    }
    
    // Form validation before submit
    $('#partnerForm').on('submit', function(e) {
        const selectedEmails = emailContactsSelect.val();
        
        if (selectedEmails && selectedEmails.length > 10) {
            e.preventDefault();
            alert('Możesz wybrać maksymalnie 10 adresów email.');
            
            // Switch to the contacts tab
            $('#contacts-tab').tab('show');
            return false;
        }
        
        return true;
    });
    
    // Activate first tab on page load
    document.querySelector('#partnerFormTabs button[data-bs-toggle="tab"]').click();
});
</script>

<style>
/* Custom styles for subscriber selection */
.contact-select-container {
    position: relative;
}

.select2-container--bootstrap-5 .select2-selection {
    border-radius: 0.375rem;
    border-color: #ced4da;
    padding: 0.25rem 0.5rem;
    min-height: 38px;
}

/* Style dla Select2 country - wyraźniejsze jako dropdown */
.select2-container--bootstrap-5.select2-container--focus .select2-selection,
.select2-container--bootstrap-5.select2-container--open .select2-selection {
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

/* Dodanie strzałki w dół, aby było widać że to dropdown */
.select2-container--bootstrap-5 .select2-selection--single {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 0.75rem center;
    background-size: 16px 12px;
    padding-right: 2rem !important;
}

/* Style dla dropdown kraju */
.country-dropdown-menu {
    border: 1px solid #ced4da;
    box-shadow: 0 3px 8px rgba(0,0,0,0.15);
    z-index: 1050;
}

.dropdown-toggle {
    background-color: #fff;
    text-align: left;
    position: relative;
}

.dropdown-toggle::after {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
}

.country-items {
    max-height: 250px;
    overflow-y: auto;
}

.new-subscriber-option {
    padding: 8px;
    color: #198754;
}

.subscriber-result {
    padding: 8px;
}

/* Make sure modals appear above Select2 dropdowns */
.modal {
    z-index: 1060;
}
</style>
{% endblock %}