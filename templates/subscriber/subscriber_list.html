{% extends "base.html" %}
{% load static %}

{% block title %}Lista subskrybentów | XManager{% endblock %}

{% block page_title %}Lista subskrybentów{% endblock %}

{% block page_actions %}
    <a href="{% url 'subscribers:subscriber_create_form' %}" class="btn btn-primary">
        <i class="fas fa-plus me-1"></i> Dodaj subskrybenta
    </a>
{% endblock %}


{% block content %}
    {% csrf_token %}
    
    <!-- Search and Filters - Compact Wide Bar -->
    <div class="card mb-2">
        <div class="card-body py-2">
            <form method="get" action="{% url 'subscribers:subscriber_list' %}" id="filterForm" class="row align-items-center">
                <!-- Left section - Search -->
                <div class="col-md-4">
                    <div class="input-group input-group-sm">
                        <input type="text" class="form-control form-control-sm" name="search" 
                               placeholder="Szukaj po email, imieniu, nazwisku, firmie..." 
                               value="{{ search_query|default:'' }}">
                        <button class="btn btn-outline-primary btn-sm" type="submit">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Middle section - Filter buttons -->
                <div class="col-md-6">
                    <div class="d-flex flex-wrap gap-2">
                        <!-- Filtr: Firma -->
                        <div class="dropdown">
                            <button class="btn btn-sm btn-light filter-btn" type="button" id="partnerFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-building"></i>
                                <span class="ms-1">Firmy</span>
                                <span class="filter-badge badge bg-primary ms-1 d-none" id="partnerFilterBadge">0</span>
                            </button>
                            <div class="dropdown-menu p-2 shadow-sm" style="width: 300px; font-size: 0.8rem;" aria-labelledby="partnerFilterDropdown">
                                <div style="max-height: 200px; overflow-y: auto;">
                                    {% for partner in all_partners|dictsort:"name" %}
                                    <div class="form-check small">
                                        <input class="form-check-input filter-checkbox" type="checkbox" name="partner" value="{{ partner.id }}" id="filter_partner_{{ partner.id }}" 
                                            {% if partner.id|stringformat:"i" in selected_partners %}checked{% endif %}
                                        >
                                        <label class="form-check-label" for="filter_partner_{{ partner.id }}">
                                            {{ partner.name }}
                                        </label>
                                    </div>
                                    {% endfor %}
                                </div>
                                <div class="d-flex justify-content-end mt-2">
                                    <button type="button" class="btn btn-sm btn-primary filter-submit-btn">
                                        <i class="fas fa-filter me-1"></i> Filtruj
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Filtr: Grupa -->
                        <div class="dropdown">
                            <button class="btn btn-sm btn-light filter-btn" type="button" id="groupFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-users"></i>
                                <span class="ms-1">Grupy</span>
                                <span class="filter-badge badge bg-primary ms-1 d-none" id="groupFilterBadge">0</span>
                            </button>
                            <div class="dropdown-menu p-2 shadow-sm" style="width: 300px; font-size: 0.8rem;" aria-labelledby="groupFilterDropdown">
                                <div style="max-height: 200px; overflow-y: auto;">
                                    {% for group in subscriber_groups %}
                                    <div class="form-check small">
                                        <input class="form-check-input filter-checkbox" type="checkbox" name="group" value="{{ group.id }}" id="filter_group_{{ group.id }}"
                                            {% if group.id|stringformat:"i" in selected_groups %}checked{% endif %}
                                        >
                                        <label class="form-check-label" for="filter_group_{{ group.id }}">
                                            {{ group.group_name }}
                                        </label>
                                    </div>
                                    {% endfor %}
                                </div>
                                <div class="d-flex justify-content-end mt-2">
                                    <button type="button" class="btn btn-sm btn-primary filter-submit-btn">
                                        <i class="fas fa-filter me-1"></i> Filtruj
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Filtr: Zgoda -->
                        <div class="dropdown">
                            <button class="btn btn-sm btn-light filter-btn" type="button" id="consentFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-check-circle"></i>
                                <span class="ms-1">Zgoda</span>
                                <span class="filter-badge badge bg-primary ms-1 {% if not selected_consent %}d-none{% endif %}" id="consentFilterBadge">
                                    {% if selected_consent %}1{% endif %}
                                </span>
                            </button>
                            <div class="dropdown-menu p-2 shadow-sm" style="min-width: 200px; font-size: 0.8rem;" aria-labelledby="consentFilterDropdown">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="consent" id="consent_all" value="" {% if not selected_consent %}checked{% endif %}>
                                    <label class="form-check-label" for="consent_all">Wszystkie</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="consent" id="consent_yes" value="1" {% if selected_consent == '1' %}checked{% endif %}>
                                    <label class="form-check-label" for="consent_yes">Tak</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="consent" id="consent_no" value="0" {% if selected_consent == '0' %}checked{% endif %}>
                                    <label class="form-check-label" for="consent_no">Nie</label>
                                </div>
                                <div class="d-flex justify-content-end mt-2">
                                    <button type="button" class="btn btn-sm btn-primary filter-submit-btn">
                                        <i class="fas fa-filter me-1"></i> Filtruj
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Filtr: Ilość rekordów na stronę -->
                        <div class="dropdown">
                            <button class="btn btn-sm btn-light filter-btn" type="button" id="pageSizeFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-list"></i>
                                <span class="ms-1" id="pageSizeText">{{ selected_page_size|default:default_page_size }} rekordów</span>
                            </button>
                            <div class="dropdown-menu p-2 shadow-sm" style="font-size: 0.8rem;" aria-labelledby="pageSizeFilterDropdown">
                                <a href="#" class="dropdown-item page-size-item d-flex align-items-center {% if selected_page_size == '50' %}active{% endif %}" data-page-size="50">
                                    50 rekordów
                                    {% if selected_page_size == '50' %}<i class="fas fa-check ms-auto"></i>{% endif %}
                                </a>
                                <a href="#" class="dropdown-item page-size-item d-flex align-items-center {% if selected_page_size == '100' %}active{% endif %}" data-page-size="100">
                                    100 rekordów
                                    {% if selected_page_size == '100' %}<i class="fas fa-check ms-auto"></i>{% endif %}
                                </a>
                                <a href="#" class="dropdown-item page-size-item d-flex align-items-center {% if selected_page_size == '200' %}active{% endif %}" data-page-size="200">
                                    200 rekordów
                                    {% if selected_page_size == '200' %}<i class="fas fa-check ms-auto"></i>{% endif %}
                                </a>
                                <a href="#" class="dropdown-item page-size-item d-flex align-items-center {% if selected_page_size == '500' %}active{% endif %}" data-page-size="500">
                                    500 rekordów
                                    {% if selected_page_size == '500' %}<i class="fas fa-check ms-auto"></i>{% endif %}
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Right section - Action buttons -->
                <div class="col-md-2 text-end">
                    <button type="submit" class="btn btn-sm btn-primary">
                        <i class="fas fa-filter me-1"></i> Filtruj
                    </button>
                    
                    <a href="{% url 'subscribers:subscriber_list' %}" class="btn btn-sm btn-outline-secondary ms-1">
                        <i class="fas fa-undo me-1"></i> Reset
                    </a>
                </div>
            </form>
        </div>
    </div>
    
   <!-- Active Filters Display -->
{% if search_query or selected_groups or selected_partners or selected_consent %}
<div class="card mb-2">
    <div class="card-body py-2">
        <div class="d-flex flex-wrap align-items-center gap-2">
            <span class="text-muted small me-2">Aktywne filtry:</span>
            
            {% if search_query %}
            <div class="active-filter">
                <span class="small">Wyszukiwanie: "{{ search_query }}"</span>
                <a href="{% url 'subscribers:subscriber_list' %}?{% for k, v in request.GET.items %}{% if k != 'search' and k != 'page' %}{{ k }}={{ v }}&{% endif %}{% endfor %}" class="ms-1 filter-remove" title="Usuń filtr">
                    <i class="fas fa-times-circle"></i>
                </a>
            </div>
            {% endif %}
            
            {% if selected_groups %}
            {% for group_id in selected_groups %}
            <div class="active-filter">
                <span class="badge badge-group">Grupa: 
                {% for group in subscriber_groups %}
                    {% if group.id|stringformat:"i" == group_id %}
                        {{ group.group_name }}
                    {% endif %}
                {% endfor %}
                </span>
                <a href="{% url 'subscribers:subscriber_list' %}?{% if search_query %}search={{ search_query }}&{% endif %}{% if selected_consent %}consent={{ selected_consent }}&{% endif %}{% if selected_page_size %}page_size={{ selected_page_size }}&{% endif %}{% for sg_id in selected_groups %}{% if sg_id != group_id %}group={{ sg_id }}&{% endif %}{% endfor %}{% for p_id in selected_partners %}partner={{ p_id }}&{% endfor %}" class="ms-1 filter-remove" title="Usuń filtr">
                    <i class="fas fa-times-circle"></i>
                </a>
            </div>
            {% endfor %}
            {% endif %}
            
            {% if selected_partners %}
            {% for partner_id in selected_partners %}
            <div class="active-filter">
                <span class="badge badge-company">Firma: 
                {% for partner in all_partners %}
                    {% if partner.id|stringformat:"i" == partner_id %}
                        {{ partner.name }}
                    {% endif %}
                {% endfor %}
                </span>
                <a href="{% url 'subscribers:subscriber_list' %}?{% if search_query %}search={{ search_query }}&{% endif %}{% if selected_consent %}consent={{ selected_consent }}&{% endif %}{% if selected_page_size %}page_size={{ selected_page_size }}&{% endif %}{% for g_id in selected_groups %}group={{ g_id }}&{% endfor %}{% for p_id in selected_partners %}{% if p_id != partner_id %}partner={{ p_id }}&{% endif %}{% endfor %}" class="ms-1 filter-remove" title="Usuń filtr">
                    <i class="fas fa-times-circle"></i>
                </a>
            </div>
            {% endfor %}
            {% endif %}
            
            {% if selected_consent %}
            <div class="active-filter">
                <span class="small">
                    Zgoda: 
                    {% if selected_consent == '1' %}
                        <span class="badge badge-active">Tak</span>
                    {% else %}
                        <span class="badge badge-inactive">Nie</span>
                    {% endif %}
                </span>
                <a href="{% url 'subscribers:subscriber_list' %}?{% if search_query %}search={{ search_query }}&{% endif %}{% if selected_page_size %}page_size={{ selected_page_size }}&{% endif %}{% for g_id in selected_groups %}group={{ g_id }}&{% endfor %}{% for p_id in selected_partners %}partner={{ p_id }}&{% endfor %}" class="ms-1 filter-remove" title="Usuń filtr">
                    <i class="fas fa-times-circle"></i>
                </a>
            </div>
            {% endif %}
            
            <div class="ms-auto">
                <a href="{% url 'subscribers:subscriber_list' %}" class="btn btn-sm btn-outline-secondary">
                    <i class="fas fa-times me-1"></i> Wyczyść wszystkie
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}
    
    <!-- Bulk Actions - Compact Row -->
    <div class="card mb-3">
        <div class="card-body py-2">
            <form method="post" action="{% url 'subscribers:subscriber_bulk_action' %}" id="bulkActionForm" class="row align-items-center">
                {% csrf_token %}
                <div id="subscriber-checkboxes"></div>
                
                <!-- Left section - Bulk action buttons -->
                <div class="col-md-9">
                    <div class="d-flex flex-wrap gap-2">
                        <!-- Edit Selected Button -->
                        <button type="button" class="btn btn-sm btn-primary" onclick="submitBulkEditForm()">
                            <i class="fas fa-edit me-1"></i> Arkusz Edycji
                        </button>
                        
                        <!-- Newsletter Consent Dropdown -->
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="newsletterConsentDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-envelope me-1"></i> Zgoda
                            </button>
                            <ul class="dropdown-menu" style="font-size: 0.8rem;" aria-labelledby="newsletterConsentDropdown">
                                <li>
                                    <button type="submit" class="dropdown-item" name="bulk_action" value="consent_yes">
                                        <i class="fas fa-check text-success me-1"></i> Ustaw "Tak"
                                    </button>
                                </li>
                                <li>
                                    <button type="submit" class="dropdown-item" name="bulk_action" value="consent_no">
                                        <i class="fas fa-times text-danger me-1"></i> Ustaw "Nie"
                                    </button>
                                </li>
                            </ul>
                        </div>
                        
                        <!-- Groups Assignment Dropdown -->
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="groupsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-users me-1"></i> Grupy
                            </button>
                            <div class="dropdown-menu p-2" style="font-size: 0.8rem;" aria-labelledby="groupsDropdown">
                                <div style="max-height: 180px; overflow-y: auto;">
                                    {% for group in subscriber_groups %}
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="group_ids" value="{{ group.id }}" id="group_{{ group.id }}">
                                        <label class="form-check-label" for="group_{{ group.id }}">
                                            {{ group.group_name }}
                                        </label>
                                    </div>
                                    {% endfor %}
                                </div>
                                <div class="d-flex justify-content-between mt-2">
                                    <button type="submit" class="btn btn-sm btn-outline-primary" name="bulk_action" value="add_to_groups">
                                        <i class="fas fa-plus-circle me-1"></i> Dodaj
                                    </button>
                                    <button type="submit" class="btn btn-sm btn-outline-danger" name="bulk_action" value="remove_from_groups">
                                        <i class="fas fa-minus-circle me-1"></i> Usuń
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Companies Assignment Dropdown -->
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="companiesDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-building me-1"></i> Firmy
                            </button>
                            <div class="dropdown-menu p-2" style="font-size: 0.8rem;" aria-labelledby="companiesDropdown">
                                <div style="max-height: 180px; overflow-y: auto;">
                                    {% for partner in all_partners|dictsort:"name" %}
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="partner_ids" value="{{ partner.id }}" id="partner_{{ partner.id }}">
                                        <label class="form-check-label" for="partner_{{ partner.id }}">
                                            {{ partner.name }}
                                        </label>
                                    </div>
                                    {% endfor %}
                                </div>
                                <div class="d-flex justify-content-between mt-2">
                                    <button type="submit" class="btn btn-sm btn-outline-primary" name="bulk_action" value="add_to_partners">
                                        <i class="fas fa-plus-circle me-1"></i> Dodaj
                                    </button>
                                    <button type="submit" class="btn btn-sm btn-outline-danger" name="bulk_action" value="remove_from_partners">
                                        <i class="fas fa-minus-circle me-1"></i> Usuń
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Right section - Selection count -->
                <div class="col-md-3 text-end">
                    <div class="d-inline-block">
                        <span class="text-muted small">Zaznaczono </span>
                        <span class="fw-bold text-primary" id="selectedCount">0</span>
                        <span class="text-muted small"> subskrybentów</span>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Ukryty formularz do przekazania zaznaczonych ID -->
    <form id="bulkEditForm" action="{% url 'subscribers:subscriber_bulk_edit' %}" method="post" style="display: none;">
        {% csrf_token %}
        <input type="hidden" name="selected_ids" id="selected_ids_input">
    </form>

    <!-- Lista subskrybentów -->
    <div class="card">
        <div class="card-body">
            {% if subscribers %}
            <div class="table-responsive">
                <table class="table table-hover table-sm">
                    <thead>
                        <tr>
                            <th>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="selectAllSubscribers" onclick="toggleCheckAll(this)">
                                </div>
                            </th>
                            <th scope="col">Email</th>
                            <th scope="col">Nazwa</th>
                            <th scope="col">Imię</th>
                            <th scope="col">Nazwisko</th>
                            <th scope="col">Firma</th>
                            <th scope="col">Grupa</th>
                            <th scope="col">Zgoda</th>
                            <th scope="col">Akcje</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for subscriber in subscribers %}
                        <tr>
                            <td>
                                <div class="form-check">
                                    <input class="form-check-input subscriber-checkbox" type="checkbox" name="subscriber_ids" value="{{ subscriber.id }}" onclick="updateBulkActions()">
                                </div>
                            </td>
                            <td>{{ subscriber.email }}</td>
                            <td>{{ subscriber.common_name|default:"-" }}</td>
                            <td>{{ subscriber.first_name|default:"-" }}</td>
                            <td>{{ subscriber.last_name|default:"-" }}</td>
                            <td>
                                {% if subscriber.partnered_with.all %}
                                    {% with partner_list=subscriber.partnered_with.all|slice:":3" %}
                                        {% for partner in partner_list %}
                                            <span class="badge badge-company text-wrap text-start mb-1 d-block" style="max-width: 150px; text-overflow: ellipsis; overflow: hidden;">
                                                {{ partner.name|truncatechars:20 }}
                                            </span>
                                        {% endfor %}
                                        {% if subscriber.partnered_with.count > 3 %}
                                            <span class="badge bg-secondary">+{{ subscriber.partnered_with.count|add:"-3" }} więcej</span>
                                        {% endif %}
                                    {% endwith %}
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if subscriber.group_affiliation.all %}
                                    {% for group in subscriber.group_affiliation.all %}
                                        <span class="badge badge-group">{{ group.group_name }}</span>
                                    {% endfor %}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                {% if subscriber.newsletter_consent %}
                                    <span class="badge badge-active">Tak</span>
                                {% else %}
                                    <span class="badge badge-inactive">Nie</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group">
                                    <a href="{% url 'subscribers:subscriber_update' subscriber.id %}" class="btn btn-sm btn-outline-secondary btn-action" title="Edytuj">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <a href="{% url 'subscribers:subscriber_delete_confirm' subscriber.id %}" class="btn btn-sm btn-outline-danger btn-action" title="Usuń">
                                        <i class="fas fa-trash"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Paginacja -->
            {% if is_paginated %}
            <nav aria-label="Nawigacja stronicowania">
                <ul class="pagination pagination-sm justify-content-center mt-3">
                    {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" aria-label="Pierwsza">
                            <span aria-hidden="true">&laquo;&laquo;</span>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" aria-label="Poprzednia">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                    {% endif %}
                    
                    {% for i in paginator.page_range %}
                        {% if page_obj.number == i %}
                            <li class="page-item active"><a class="page-link" href="#">{{ i }}</a></li>
                        {% elif i > page_obj.number|add:'-3' and i < page_obj.number|add:'3' %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ i }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ i }}</a>
                            </li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" aria-label="Następna">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" aria-label="Ostatnia">
                            <span aria-hidden="true">&raquo;&raquo;</span>
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
            {% else %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i> Brak subskrybentów do wyświetlenia.
            </div>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
// Funkcja aktualizująca tylko licznik zaznaczonych subskrybentów
function updateBulkActions() {
    const checkboxes = document.querySelectorAll('input.subscriber-checkbox:checked');
    const countElement = document.getElementById('selectedCount');
    countElement.textContent = checkboxes.length;
}

// Funkcja przełączająca wszystkie checkboxy
function toggleCheckAll(source) {
    const checkboxes = document.querySelectorAll('input.subscriber-checkbox');
    for (let i = 0; i < checkboxes.length; i++) {
        checkboxes[i].checked = source.checked;
    }
    updateBulkActions();
}

// Funkcja do przesyłania formularza edycji zbiorczej
function submitBulkEditForm() {
    // Zbierz zaznaczone ID
    const checkboxes = document.querySelectorAll('input.subscriber-checkbox:checked');
    const ids = Array.from(checkboxes).map(cb => cb.value);
    
    if (ids.length === 0) {
        alert('Proszę zaznaczyć co najmniej jednego subskrybenta.');
        return;
    }
    
    // Zaktualizuj ukryte pole
    document.getElementById('selected_ids_input').value = ids.join(',');
    
    // Wyślij formularz
    document.getElementById('bulkEditForm').submit();
}

// Funkcja do przygotowania formularza akcji masowych
function prepareBulkActionForm() {
    // Pobierz wszystkie zaznaczone checkboxy
    const checkboxes = document.querySelectorAll('input.subscriber-checkbox:checked');
    
    if (checkboxes.length === 0) {
        alert('Proszę zaznaczyć co najmniej jednego subskrybenta.');
        return false;
    }
    
    // Pobierz kontener na checkboxy w formularzu akcji masowych
    const checkboxContainer = document.getElementById('subscriber-checkboxes');
    
    // Wyczyść kontener
    checkboxContainer.innerHTML = '';
    
    // Dodaj ukryte inputy dla każdego zaznaczonego ID
    checkboxes.forEach(checkbox => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'subscriber_ids';
        input.value = checkbox.value;
        checkboxContainer.appendChild(input);
    });
    
    return true;
}

// Funkcja aktualizująca liczniki filtrów
function updateFilterCounters() {
    const partnerCount = $('input[name="partner"]:checked').length;
    const groupCount = $('input[name="group"]:checked').length;
    const consentSelected = $('input[name="consent"]:checked').val() !== '';
    
    // Update partner filter badge
    if (partnerCount > 0) {
        $('#partnerFilterBadge').text(partnerCount).removeClass('d-none');
    } else {
        $('#partnerFilterBadge').addClass('d-none');
    }
    
    // Update group filter badge
    if (groupCount > 0) {
        $('#groupFilterBadge').text(groupCount).removeClass('d-none');
    } else {
        $('#groupFilterBadge').addClass('d-none');
    }
    
    // Update consent filter badge
    if (consentSelected) {
        $('#consentFilterBadge').removeClass('d-none');
    } else {
        $('#consentFilterBadge').addClass('d-none');
    }
    
    // Update page size text - używamy wartości z Django
    const defaultPageSize = "{{ default_page_size }}";
    // Przy nowym rozwiązaniu nie używamy już radio buttonów, więc odczytujemy z tekstu
    const currentPageSize = $('#pageSizeText').text().split(' ')[0];
    $('#pageSizeText').text(currentPageSize + ' rekordów');
}

// Inicjalizacja stanu po załadowaniu strony
document.addEventListener('DOMContentLoaded', function() {
    // Inicjalizacja licznika zaznaczonych subskrybentów
    updateBulkActions();
    
    // Dodaj obsługę kliknięć dla przycisków akcji masowych
    document.querySelectorAll('[name="bulk_action"]').forEach(button => {
        button.addEventListener('click', function(e) {
            if (!prepareBulkActionForm()) {
                e.preventDefault(); // Zatrzymaj przesłanie formularza jeśli nie wybrano subskrybentów
            }
        });
    });
    
    // Obsługa dropdownów filtrów
    
    // Radio button change handler (for consent)
    $('input[type=radio][name=consent]').on('change', function() {
        updateFilterCounters();
    });
    
    // Obsługa bezpośredniego wyboru rozmiaru strony
    $('.page-size-item').on('click', function(e) {
        e.preventDefault();
        
        // Pobierz wybrany rozmiar strony
        const pageSize = $(this).data('page-size');
        
        // Aktualizuj tekst w przycisku dropdown
        $('#pageSizeText').text(pageSize + ' rekordów');
        
        // Dodaj ukryte pole z rozmiarem strony do formularza
        let pageSizeInput = $('#filterForm input[name="page_size"]');
        if (pageSizeInput.length === 0) {
            pageSizeInput = $('<input>').attr({
                type: 'hidden',
                name: 'page_size',
                id: 'page_size_input'
            }).appendTo('#filterForm');
        }
        pageSizeInput.val(pageSize);
        
        // Wyślij formularz
        $('#filterForm').submit();
    });
    
    // Prevent dropdown from closing when clicking inside (except for page-size-item)
    $('.dropdown-menu').on('click', function(e) {
        if (!$(e.target).hasClass('page-size-item') && 
            !$(e.target).parent().hasClass('page-size-item')) {
            e.stopPropagation();
        }
    });
    
    // Submit form when filter button clicked
    $('.filter-submit-btn').on('click', function() {
        updateFilterCounters();
        // Close the dropdown
        $(this).closest('.dropdown-menu').prev('.dropdown-toggle').dropdown('toggle');
        // Submit the form
        $('#filterForm').submit();
    });
    
    // Update filter checkbox handling
    $('.filter-checkbox').on('change', function() {
        updateFilterCounters();
    });
    
    // Initialize filter counters
    updateFilterCounters();
});
</script>

{% endblock %}