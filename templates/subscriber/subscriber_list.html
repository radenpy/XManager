{% extends "base.html" %}
{% load static %}

{% block title %}Lista subskrybentów | XManager{% endblock %}

{% block page_title %}Lista subskrybentów{% endblock %}

{% block page_actions %}
    <a href="{% url 'subscribers:subscriber_import' %}" class="btn btn-outline-secondary">
        <i class="fas fa-file-import me-1"></i> Importuj
    </a>
    <a href="{% url 'subscribers:subscriber_create_form' %}" class="btn btn-primary ms-2">
        <i class="fas fa-plus me-1"></i> Dodaj subskrybenta
    </a>
{% endblock %}

{% block content %}
    {% csrf_token %}
    
    <!-- Search and Filters - Compact Wide Bar -->
    <div class="card mb-2">
        <div class="card-body py-2">
            <form method="get" action="{% url 'subscribers:subscriber_list' %}" id="filterForm" class="row align-items-center">
                <!-- Left section - Search -->
                <div class="col-md-4">
                    <div class="input-group input-group-sm">
                        <input type="text" class="form-control form-control-sm" name="search" 
                               placeholder="Szukaj po email, imieniu, nazwisku, firmie..." 
                               value="{{ search_query|default:'' }}">
                        <button class="btn btn-outline-primary btn-sm" type="submit">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Middle section - Filter buttons -->
                <div class="col-md-6">
                    <div class="d-flex flex-wrap gap-2">
                        <!-- Filtr: Firma -->
                        <div class="dropdown">
                            <button class="btn btn-sm btn-light filter-btn" type="button" id="partnerFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-building"></i>
                                <span class="ms-1">Firmy</span>
                                <span class="filter-badge badge bg-primary ms-1 d-none" id="partnerFilterBadge">0</span>
                            </button>
                            <div class="dropdown-menu p-2 shadow-sm" style="width: 300px; font-size: 0.8rem;" aria-labelledby="partnerFilterDropdown">
                                <div class="mb-2">
                                    <input type="text" class="form-control form-control-sm search-filter" placeholder="Szukaj firmy..." id="partnerSearchInput">
                                </div>
                                <div style="max-height: 200px; overflow-y: auto;" id="partnerFilterList">
                                    {% for partner in all_partners|dictsort:"name" %}
                                    <div class="form-check small partner-filter-item">
                                        <input class="form-check-input filter-checkbox" type="checkbox" name="partner" value="{{ partner.id }}" id="filter_partner_{{ partner.id }}" 
                                            {% if partner.id|stringformat:"i" in selected_partners %}checked{% endif %}
                                        >
                                        <label class="form-check-label" for="filter_partner_{{ partner.id }}" data-search-text="{{ partner.name|lower }}">
                                            {{ partner.name }}
                                        </label>
                                    </div>
                                    {% endfor %}
                                </div>
                                <div class="d-flex justify-content-between mt-2">
                                    <button type="button" class="btn btn-sm btn-outline-secondary filter-select-all" data-target="partner">Zaznacz wszystkie</button>
                                    <button type="button" class="btn btn-sm btn-primary filter-submit-btn">
                                        <i class="fas fa-filter me-1"></i> Filtruj
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Filtr: Grupa -->
                        <div class="dropdown">
                            <button class="btn btn-sm btn-light filter-btn" type="button" id="groupFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-users"></i>
                                <span class="ms-1">Grupy</span>
                                <span class="filter-badge badge bg-primary ms-1 d-none" id="groupFilterBadge">0</span>
                            </button>
                            <div class="dropdown-menu p-2 shadow-sm" style="width: 300px; font-size: 0.8rem;" aria-labelledby="groupFilterDropdown">
                                <div class="mb-2">
                                    <input type="text" class="form-control form-control-sm search-filter" placeholder="Szukaj grupy..." id="groupSearchInput">
                                </div>
                                <div style="max-height: 200px; overflow-y: auto;" id="groupFilterList">
                                    {% for group in subscriber_groups %}
                                    <div class="form-check small group-filter-item">
                                        <input class="form-check-input filter-checkbox" type="checkbox" name="group" value="{{ group.id }}" id="filter_group_{{ group.id }}"
                                            {% if group.id|stringformat:"i" in selected_groups %}checked{% endif %}
                                        >
                                        <label class="form-check-label" for="filter_group_{{ group.id }}" data-search-text="{{ group.group_name|lower }}">
                                            {{ group.group_name }}
                                        </label>
                                    </div>
                                    {% endfor %}
                                </div>
                                <div class="d-flex justify-content-between mt-2">
                                    <button type="button" class="btn btn-sm btn-outline-secondary filter-select-all" data-target="group">Zaznacz wszystkie</button>
                                    <button type="button" class="btn btn-sm btn-primary filter-submit-btn">
                                        <i class="fas fa-filter me-1"></i> Filtruj
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Filtr: Zgoda -->
                        <div class="dropdown">
                            <button class="btn btn-sm btn-light filter-btn" type="button" id="consentFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-check-circle"></i>
                                <span class="ms-1">Zgoda</span>
                                <span class="filter-badge badge bg-primary ms-1 {% if not selected_consent %}d-none{% endif %}" id="consentFilterBadge">
                                    {% if selected_consent %}1{% endif %}
                                </span>
                            </button>
                            <div class="dropdown-menu p-2 shadow-sm" style="min-width: 200px; font-size: 0.8rem;" aria-labelledby="consentFilterDropdown">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="consent" id="consent_all" value="" {% if not selected_consent %}checked{% endif %}>
                                    <label class="form-check-label" for="consent_all">Wszystkie</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="consent" id="consent_yes" value="1" {% if selected_consent == '1' %}checked{% endif %}>
                                    <label class="form-check-label" for="consent_yes">Tak</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="consent" id="consent_no" value="0" {% if selected_consent == '0' %}checked{% endif %}>
                                    <label class="form-check-label" for="consent_no">Nie</label>
                                </div>
                                <div class="d-flex justify-content-end mt-2">
                                    <button type="button" class="btn btn-sm btn-primary filter-submit-btn">
                                        <i class="fas fa-filter me-1"></i> Filtruj
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Filtr: Ilość rekordów na stronę -->
                        <div class="dropdown">
                            <button class="btn btn-sm btn-light filter-btn" type="button" id="pageSizeFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-list"></i>
                                <span class="ms-1" id="pageSizeText">{{ selected_page_size|default:default_page_size }} rekordów</span>
                            </button>
                            <div class="dropdown-menu p-2 shadow-sm" style="font-size: 0.8rem;" aria-labelledby="pageSizeFilterDropdown">
                                <a href="#" class="dropdown-item page-size-item d-flex align-items-center {% if selected_page_size == '50' %}active{% endif %}" data-page-size="50">
                                    50 rekordów
                                    {% if selected_page_size == '50' %}<i class="fas fa-check ms-auto"></i>{% endif %}
                                </a>
                                <a href="#" class="dropdown-item page-size-item d-flex align-items-center {% if selected_page_size == '100' %}active{% endif %}" data-page-size="100">
                                    100 rekordów
                                    {% if selected_page_size == '100' %}<i class="fas fa-check ms-auto"></i>{% endif %}
                                </a>
                                <a href="#" class="dropdown-item page-size-item d-flex align-items-center {% if selected_page_size == '200' %}active{% endif %}" data-page-size="200">
                                    200 rekordów
                                    {% if selected_page_size == '200' %}<i class="fas fa-check ms-auto"></i>{% endif %}
                                </a>
                                <a href="#" class="dropdown-item page-size-item d-flex align-items-center {% if selected_page_size == '500' %}active{% endif %}" data-page-size="500">
                                    500 rekordów
                                    {% if selected_page_size == '500' %}<i class="fas fa-check ms-auto"></i>{% endif %}
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Right section - Action buttons -->
                <div class="col-md-2 text-end">
                    <button type="submit" class="btn btn-sm btn-primary">
                        <i class="fas fa-filter me-1"></i> Filtruj
                    </button>
                    
                    <a href="{% url 'subscribers:subscriber_list' %}" class="btn btn-sm btn-outline-secondary ms-1">
                        <i class="fas fa-undo me-1"></i> Reset
                    </a>
                </div>
            </form>
        </div>
    </div>
    
   <!-- Active Filters Display -->
{% if search_query or selected_groups or selected_partners or selected_consent %}
<div class="card mb-2">
    <div class="card-body py-2">
        <div class="d-flex flex-wrap align-items-center gap-2">
            <span class="text-muted small me-2">Aktywne filtry:</span>
            
            {% if search_query %}
            <div class="active-filter">
                <span class="small">Wyszukiwanie: "{{ search_query }}"</span>
                <a href="{% url 'subscribers:subscriber_list' %}?{% for k, v in request.GET.items %}{% if k != 'search' and k != 'page' %}{{ k }}={{ v }}&{% endif %}{% endfor %}" class="ms-1 filter-remove" title="Usuń filtr">
                    <i class="fas fa-times-circle"></i>
                </a>
            </div>
            {% endif %}
            
            {% if selected_groups %}
            {% for group_id in selected_groups %}
            <div class="active-filter">
                <span class="badge badge-group">Grupa: 
                {% for group in subscriber_groups %}
                    {% if group.id|stringformat:"i" == group_id %}
                        {{ group.group_name }}
                    {% endif %}
                {% endfor %}
                </span>
                <a href="{% url 'subscribers:subscriber_list' %}?{% if search_query %}search={{ search_query }}&{% endif %}{% if selected_consent %}consent={{ selected_consent }}&{% endif %}{% if selected_page_size %}page_size={{ selected_page_size }}&{% endif %}{% for sg_id in selected_groups %}{% if sg_id != group_id %}group={{ sg_id }}&{% endif %}{% endfor %}{% for p_id in selected_partners %}partner={{ p_id }}&{% endfor %}" class="ms-1 filter-remove" title="Usuń filtr">
                    <i class="fas fa-times-circle"></i>
                </a>
            </div>
            {% endfor %}
            {% endif %}
            
            {% if selected_partners %}
            {% for partner_id in selected_partners %}
            <div class="active-filter">
                <span class="badge badge-company">Firma: 
                {% for partner in all_partners %}
                    {% if partner.id|stringformat:"i" == partner_id %}
                        {{ partner.name }}
                    {% endif %}
                {% endfor %}
                </span>
                <a href="{% url 'subscribers:subscriber_list' %}?{% if search_query %}search={{ search_query }}&{% endif %}{% if selected_consent %}consent={{ selected_consent }}&{% endif %}{% if selected_page_size %}page_size={{ selected_page_size }}&{% endif %}{% for g_id in selected_groups %}group={{ g_id }}&{% endfor %}{% for p_id in selected_partners %}{% if p_id != partner_id %}partner={{ p_id }}&{% endif %}{% endfor %}" class="ms-1 filter-remove" title="Usuń filtr">
                    <i class="fas fa-times-circle"></i>
                </a>
            </div>
            {% endfor %}
            {% endif %}
            
            {% if selected_consent %}
            <div class="active-filter">
                <span class="small">
                    Zgoda: 
                    {% if selected_consent == '1' %}
                        <span class="badge badge-active">Tak</span>
                    {% else %}
                        <span class="badge badge-inactive">Nie</span>
                    {% endif %}
                </span>
                <a href="{% url 'subscribers:subscriber_list' %}?{% if search_query %}search={{ search_query }}&{% endif %}{% if selected_page_size %}page_size={{ selected_page_size }}&{% endif %}{% for g_id in selected_groups %}group={{ g_id }}&{% endfor %}{% for p_id in selected_partners %}partner={{ p_id }}&{% endfor %}" class="ms-1 filter-remove" title="Usuń filtr">
                    <i class="fas fa-times-circle"></i>
                </a>
            </div>
            {% endif %}
            
            <div class="ms-auto">
                <a href="{% url 'subscribers:subscriber_list' %}" class="btn btn-sm btn-outline-secondary">
                    <i class="fas fa-times me-1"></i> Wyczyść wszystkie
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}
    
    <!-- Bulk Actions - Compact Row -->
    <div class="card mb-3">
        <div class="card-body py-2">
            <form method="post" action="{% url 'subscribers:subscriber_bulk_action' %}" id="bulkActionForm" class="row align-items-center">
                {% csrf_token %}
                <div id="subscriber-checkboxes"></div>
                
<!-- Left section - Bulk action buttons -->
<div class="col-md-9">
    <div class="d-flex flex-wrap gap-2">
        <!-- Edit Selected Button -->
        <button type="button" class="btn btn-sm btn-primary" onclick="confirmBulkAction('edit')">
            <i class="fas fa-edit me-1"></i> Arkusz Edycji
        </button>
        
        <!-- Newsletter Consent Dropdown -->
        <div class="dropdown">
            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="newsletterConsentDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-envelope me-1"></i> Zgoda
            </button>
            <ul class="dropdown-menu" style="font-size: 0.8rem;" aria-labelledby="newsletterConsentDropdown">
                <li>
                    <button type="button" class="dropdown-item" onclick="confirmBulkAction('consent_yes')">
                        <i class="fas fa-check text-success me-1"></i> Ustaw "Tak"
                    </button>
                </li>
                <li>
                    <button type="button" class="dropdown-item" onclick="confirmBulkAction('consent_no')">
                        <i class="fas fa-times text-danger me-1"></i> Ustaw "Nie"
                    </button>
                </li>
            </ul>
        </div>
        
        <!-- Groups Assignment Dropdown -->
        <div class="dropdown">
            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="groupsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-users me-1"></i> Grupy
            </button>
            <div class="dropdown-menu p-2" style="font-size: 0.8rem;" aria-labelledby="groupsDropdown">
                <div style="max-height: 180px; overflow-y: auto;">
                    {% for group in subscriber_groups %}
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="group_ids" value="{{ group.id }}" id="group_{{ group.id }}">
                        <label class="form-check-label" for="group_{{ group.id }}">
                            {{ group.group_name }}
                        </label>
                    </div>
                    {% endfor %}
                </div>
                <div class="d-flex justify-content-between mt-2">
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="confirmBulkAction('add_to_groups')">
                        <i class="fas fa-plus-circle me-1"></i> Dodaj
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="confirmBulkAction('remove_from_groups')">
                        <i class="fas fa-minus-circle me-1"></i> Usuń
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Companies Assignment Dropdown -->
        <div class="dropdown">
            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="companiesDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-building me-1"></i> Firmy
            </button>
            <div class="dropdown-menu p-2" style="font-size: 0.8rem;" aria-labelledby="companiesDropdown">
                <div style="max-height: 180px; overflow-y: auto;">
                    {% for partner in all_partners|dictsort:"name" %}
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="partner_ids" value="{{ partner.id }}" id="partner_{{ partner.id }}">
                        <label class="form-check-label" for="partner_{{ partner.id }}">
                            {{ partner.name }}
                        </label>
                    </div>
                    {% endfor %}
                </div>
                <div class="d-flex justify-content-between mt-2">
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="confirmBulkAction('add_to_partners')">
                        <i class="fas fa-plus-circle me-1"></i> Dodaj
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="confirmBulkAction('remove_from_partners')">
                        <i class="fas fa-minus-circle me-1"></i> Usuń
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Delete Button - przeniesiony na koniec, zmieniony styl, tylko ikona -->
        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="confirmBulkAction('delete')">
            <i class="fas fa-trash"></i>
        </button>
    </div>
</div>
                
                <!-- Right section - Selection count -->
            <div class="col-md-3 text-end">
                <div class="d-inline-block">
                    <span class="text-muted small">Zaznaczono </span>
                    <span class="fw-bold text-secondary" id="selectedCount">0</span>
                    <span class="text-muted small"> z </span>
                    <span class="fw-bold text-secondary" id="totalCount">{{ subscribers|length }}</span>
                    <span class="text-muted small"> subskrybentów</span>
                </div>
            </div>
            </form>
        </div>
    </div>
    
    <!-- Ukryty formularz do przekazania zaznaczonych ID -->
    <form id="bulkEditForm" action="{% url 'subscribers:subscriber_bulk_edit' %}" method="post" style="display: none;">
        {% csrf_token %}
        <input type="hidden" name="selected_ids" id="selected_ids_input">
    </form>

    <!-- Lista subskrybentów -->
    <div class="card">
        <div class="card-body">
            {% if subscribers %}
            <div class="table-responsive">
                <table class="table table-hover table-sm">
                    <thead>
                        <tr>
                            <th>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="selectAllSubscribers" onclick="toggleCheckAll(this)">
                                </div>
                            </th>
                            <th scope="col" class="text-center" style="width: 20px;">#</th>  <!-- Nowa kolumna numeracji -->
                            <th scope="col">Email</th>
                            <th scope="col">Nazwa</th>
                            <th scope="col">Imię</th>
                            <th scope="col">Nazwisko</th>
                            <th scope="col">Firma</th>
                            <th scope="col">Grupa</th>
                            <th scope="col">Zgoda</th>
                            <th scope="col">Akcje</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for subscriber in subscribers %}
                        <tr>
                            <td>
                                <div class="form-check">
                                    <input class="form-check-input subscriber-checkbox" type="checkbox" name="subscriber_ids" value="{{ subscriber.id }}" onclick="updateBulkActions()">
                                </div>
                            </td>
                            <td class="text-center">{{ page_obj.start_index|add:forloop.counter0 }}</td>  <!-- Nowa kolumna z numeracją -->
                            <td>{{ subscriber.email }}</td>
                            <td>{{ subscriber.common_name|default:"-" }}</td>
                            <td>{{ subscriber.first_name|default:"-" }}</td>
                            <td>{{ subscriber.last_name|default:"-" }}</td>
                            <td>
                                {% if subscriber.partnered_with.all %}
                                    {% with partner_list=subscriber.partnered_with.all|slice:":3" %}
                                        {% for partner in partner_list %}
                                            <span class="badge badge-company text-wrap text-start mb-1 d-block" style="max-width: 150px; text-overflow: ellipsis; overflow: hidden;">
                                                {{ partner.name|truncatechars:20 }}
                                            </span>
                                        {% endfor %}
                                        {% if subscriber.partnered_with.count > 3 %}
                                            <span class="badge bg-secondary">+{{ subscriber.partnered_with.count|add:"-3" }} więcej</span>
                                        {% endif %}
                                    {% endwith %}
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if subscriber.group_affiliation.all %}
                                    {% for group in subscriber.group_affiliation.all %}
                                        <span class="badge badge-group">{{ group.group_name }}</span>
                                    {% endfor %}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                {% if subscriber.newsletter_consent %}
                                    <span class="badge badge-active">Tak</span>
                                {% else %}
                                    <span class="badge badge-inactive">Nie</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group">
                                    <a href="{% url 'subscribers:subscriber_update' subscriber.id %}" class="btn btn-sm btn-outline-secondary btn-action" title="Edytuj">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <a href="{% url 'subscribers:subscriber_delete_confirm' subscriber.id %}" class="btn btn-sm btn-outline-danger btn-action" title="Usuń">
                                        <i class="fas fa-trash"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Paginacja -->
            {% if is_paginated %}
            <nav aria-label="Nawigacja stronicowania">
                <ul class="pagination pagination-sm justify-content-center mt-3">
                    {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" aria-label="Pierwsza">
                            <span aria-hidden="true">&laquo;&laquo;</span>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" aria-label="Poprzednia">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                    {% endif %}
                    
                    {% for i in paginator.page_range %}
                        {% if page_obj.number == i %}
                            <li class="page-item active"><a class="page-link" href="#">{{ i }}</a></li>
                        {% elif i > page_obj.number|add:'-3' and i < page_obj.number|add:'3' %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ i }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ i }}</a>
                            </li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" aria-label="Następna">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" aria-label="Ostatnia">
                            <span aria-hidden="true">&raquo;&raquo;</span>
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
            {% else %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i> Brak subskrybentów do wyświetlenia.
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Modal potwierdzenia akcji masowej -->
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmModalLabel">Potwierdź operację</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zamknij"></button>
                </div>
                <div class="modal-body">
                    <p id="confirmMessage"></p>
                    <p id="confirmDetails" class="text-muted small"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                    <button type="button" class="btn btn-primary" id="confirmActionBtn">Potwierdź</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
// Funkcja aktualizująca tylko licznik zaznaczonych subskrybentów
function updateBulkActions() {
    const checkboxes = document.querySelectorAll('input.subscriber-checkbox:checked');
    const countElement = document.getElementById('selectedCount');
    countElement.textContent = checkboxes.length;
}

// Funkcja przełączająca wszystkie checkboxy
function toggleCheckAll(source) {
    const checkboxes = document.querySelectorAll('input.subscriber-checkbox');
    for (let i = 0; i < checkboxes.length; i++) {
        checkboxes[i].checked = source.checked;
    }
    updateBulkActions();
}

// Funkcja do przesyłania formularza edycji zbiorczej
function submitBulkEditForm() {
    // Zbierz zaznaczone ID
    const checkboxes = document.querySelectorAll('input.subscriber-checkbox:checked');
    const ids = Array.from(checkboxes).map(cb => cb.value);
    
    // Zaktualizuj ukryte pole
    document.getElementById('selected_ids_input').value = ids.join(',');
    
    // Wyślij formularz
    document.getElementById('bulkEditForm').submit();
}

// Funkcja do przygotowania formularza akcji masowych
function prepareBulkActionForm(action) {
    // Pobierz wszystkie zaznaczone checkboxy
    const checkboxes = document.querySelectorAll('input.subscriber-checkbox:checked');
    
    if (checkboxes.length === 0) {
        alert('Proszę zaznaczyć co najmniej jednego subskrybenta.');
        return false;
    }
    
    // Pobierz kontener na checkboxy w formularzu akcji masowych
    const checkboxContainer = document.getElementById('subscriber-checkboxes');
    
    // Wyczyść kontener
    checkboxContainer.innerHTML = '';
    
    // Dodaj ukryte inputy dla każdego zaznaczonego ID
    checkboxes.forEach(checkbox => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'subscriber_ids';
        input.value = checkbox.value;
        checkboxContainer.appendChild(input);
    });
    
    // Dodaj akcję
    const actionInput = document.createElement('input');
    actionInput.type = 'hidden';
    actionInput.name = 'bulk_action';
    actionInput.value = action;
    checkboxContainer.appendChild(actionInput);
    
    // Specjalne pole dla usuwania
    if (action === 'delete') {
        const confirmInput = document.createElement('input');
        confirmInput.type = 'hidden';
        confirmInput.name = 'confirm_delete';
        confirmInput.value = 'yes';
        checkboxContainer.appendChild(confirmInput);
    }
    
    return true;
}

// Funkcja do potwierdzania akcji masowych
function confirmBulkAction(action) {
    // Pobierz wszystkie zaznaczone checkboxy
    const checkboxes = document.querySelectorAll('input.subscriber-checkbox:checked');
    
    if (checkboxes.length === 0) {
        alert('Proszę zaznaczyć co najmniej jednego subskrybenta.');
        return;
    }
    
    const count = checkboxes.length;
    let message = '';
    let details = '';
    
    // Przygotuj komunikat potwierdzenia
    if (action === 'edit') {
        message = `Czy na pewno chcesz otworzyć arkusz edycji dla ${count} subskrybentów?`;
    } 
    else if (action === 'delete') {
        message = `Czy na pewno chcesz TRWALE USUNĄĆ ${count} zaznaczonych subskrybentów?`;
        details = `UWAGA: Ta operacja jest nieodwracalna i spowoduje usunięcie wszystkich danych tych subskrybentów.`;
    }
    else if (action === 'consent_yes') {
        message = `Czy na pewno chcesz ustawić zgodę na "TAK" dla ${count} subskrybentów?`;
    } 
    else if (action === 'consent_no') {
        message = `Czy na pewno chcesz ustawić zgodę na "NIE" dla ${count} subskrybentów?`;
    } 
    else if (action === 'add_to_groups') {
        // Sprawdź, czy wybrano jakieś grupy
        const selectedGroups = [];
        document.querySelectorAll('input[name="group_ids"]:checked').forEach(checkbox => {
            selectedGroups.push(checkbox.nextElementSibling.textContent.trim());
        });
        
        if (selectedGroups.length === 0) {
            alert('Proszę wybrać co najmniej jedną grupę.');
            return;
        }
        
        message = `Czy na pewno chcesz dodać ${count} subskrybentów do wybranych grup?`;
        details = `Wybrane grupy: ${selectedGroups.join(', ')}`;
    } 
    else if (action === 'remove_from_groups') {
        // Sprawdź, czy wybrano jakieś grupy
        const selectedGroups = [];
        document.querySelectorAll('input[name="group_ids"]:checked').forEach(checkbox => {
            selectedGroups.push(checkbox.nextElementSibling.textContent.trim());
        });
        
        if (selectedGroups.length === 0) {
            alert('Proszę wybrać co najmniej jedną grupę.');
            return;
        }
        
        message = `Czy na pewno chcesz usunąć ${count} subskrybentów z wybranych grup?`;
        details = `Wybrane grupy: ${selectedGroups.join(', ')}`;
    } 
    else if (action === 'add_to_partners') {
        // Sprawdź, czy wybrano jakieś firmy
        const selectedPartners = [];
        document.querySelectorAll('input[name="partner_ids"]:checked').forEach(checkbox => {
            selectedPartners.push(checkbox.nextElementSibling.textContent.trim());
        });
        
        if (selectedPartners.length === 0) {
            alert('Proszę wybrać co najmniej jedną firmę.');
            return;
        }
        
        message = `Czy na pewno chcesz dodać ${count} subskrybentów do wybranych firm?`;
        details = `Wybrane firmy: ${selectedPartners.join(', ')}`;
    } 
    else if (action === 'remove_from_partners') {
        // Sprawdź, czy wybrano jakieś firmy
        const selectedPartners = [];
        document.querySelectorAll('input[name="partner_ids"]:checked').forEach(checkbox => {
            selectedPartners.push(checkbox.nextElementSibling.textContent.trim());
        });
        
        if (selectedPartners.length === 0) {
            alert('Proszę wybrać co najmniej jedną firmę.');
            return;
        }
        
        message = `Czy na pewno chcesz usunąć ${count} subskrybentów z wybranych firm?`;
        details = `Wybrane firmy: ${selectedPartners.join(', ')}`;
    }
    
    // Ustaw treść modalu
    document.getElementById('confirmMessage').textContent = message;
    document.getElementById('confirmDetails').textContent = details;
    
    // Ustaw przycisk potwierdzenia
    const confirmButton = document.getElementById('confirmActionBtn');
    
    // Usuń istniejące event listenery
    const newConfirmButton = confirmButton.cloneNode(true);
    confirmButton.parentNode.replaceChild(newConfirmButton, confirmButton);
    
    // Dodaj nowy event listener
    newConfirmButton.addEventListener('click', function() {
        // Zamknij modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('confirmModal'));
        modal.hide();
        
        // Wykonaj akcję
        if (action === 'edit') {
            submitBulkEditForm();
        } else {
            if (prepareBulkActionForm(action)) {
                // Debug: sprawdź, co jest wysyłane
                console.log("Wysyłanie formularza z akcją:", action);
                console.log("Zaznaczone ID:", Array.from(checkboxes).map(cb => cb.value));
                
                // Wyślij formularz
                document.getElementById('bulkActionForm').submit();
            }
        }
    });
    
    // Pokaż modal
    const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
    modal.show();
}

// Funkcja aktualizująca liczniki filtrów
function updateFilterCounters() {
    const partnerCount = $('input[name="partner"]:checked').length;
    const groupCount = $('input[name="group"]:checked').length;
    const consentSelected = $('input[name="consent"]:checked').val() !== '';
    
    // Update partner filter badge
    if (partnerCount > 0) {
        $('#partnerFilterBadge').text(partnerCount).removeClass('d-none');
    } else {
        $('#partnerFilterBadge').addClass('d-none');
    }
    
    // Update group filter badge
    if (groupCount > 0) {
        $('#groupFilterBadge').text(groupCount).removeClass('d-none');
    } else {
        $('#groupFilterBadge').addClass('d-none');
    }
    
    // Update consent filter badge
    if (consentSelected) {
        $('#consentFilterBadge').removeClass('d-none');
    } else {
        $('#consentFilterBadge').addClass('d-none');
    }
    
    // Update page size text - używamy wartości z Django
    const defaultPageSize = "{{ default_page_size }}";
    // Przy nowym rozwiązaniu nie używamy już radio buttonów, więc odczytujemy z tekstu
    const currentPageSize = $('#pageSizeText').text().split(' ')[0];
    $('#pageSizeText').text(currentPageSize + ' rekordów');
}

// Filter search functionality
$('.search-filter').on('input', function() {
    const searchText = $(this).val().toLowerCase();
    const filterType = $(this).attr('id').includes('partner') ? 'partner' : 'group';
    const items = filterType === 'partner' ? $('.partner-filter-item') : $('.group-filter-item');
    
    if (searchText.length === 0) {
        // Show all items if search is empty
        items.show();
    } else {
        // Filter items based on search text
        items.each(function() {
            const itemText = $(this).find('label').data('search-text');
            if (itemText.includes(searchText)) {
                $(this).show();
            } else {
                $(this).hide();
            }
        });
    }
});

// "Select All" button functionality
$('.filter-select-all').on('click', function() {
    const target = $(this).data('target');
    const checkboxes = target === 'partner' 
        ? $('.partner-filter-item:visible input[type="checkbox"]') 
        : $('.group-filter-item:visible input[type="checkbox"]');
    
    // Check if all visible checkboxes are checked
    const allChecked = checkboxes.length === checkboxes.filter(':checked').length;
    
    // Toggle checkboxes
    checkboxes.prop('checked', !allChecked);
    
    // Update filter counters
    updateFilterCounters();
});

// Clear search fields when dropdown is closed
$('.dropdown').on('hidden.bs.dropdown', function() {
    const searchInput = $(this).find('.search-filter');
    if (searchInput.length) {
        searchInput.val('');
        // Reset visibility of all items
        if (searchInput.attr('id').includes('partner')) {
            $('.partner-filter-item').show();
        } else {
            $('.group-filter-item').show();
        }
    }
});

// Inicjalizacja stanu po załadowaniu strony
document.addEventListener('DOMContentLoaded', function() {
    // Inicjalizacja licznika zaznaczonych subskrybentów
    updateBulkActions();
    
    // Obsługa dropdownów filtrów
    
    // Radio button change handler (for consent)
    $('input[type=radio][name=consent]').on('change', function() {
        updateFilterCounters();
    });
    
    // Obsługa bezpośredniego wyboru rozmiaru strony
    $('.page-size-item').on('click', function(e) {
        e.preventDefault();
        
        // Pobierz wybrany rozmiar strony
        const pageSize = $(this).data('page-size');
        
        // Aktualizuj tekst w przycisku dropdown
        $('#pageSizeText').text(pageSize + ' rekordów');
        
        // Dodaj ukryte pole z rozmiarem strony do formularza
        let pageSizeInput = $('#filterForm input[name="page_size"]');
        if (pageSizeInput.length === 0) {
            pageSizeInput = $('<input>').attr({
                type: 'hidden',
                name: 'page_size',
                id: 'page_size_input'
            }).appendTo('#filterForm');
        }
        pageSizeInput.val(pageSize);
        
        // Wyślij formularz
        $('#filterForm').submit();
    });
    
    // Prevent dropdown from closing when clicking inside (except for page-size-item)
    $('.dropdown-menu').on('click', function(e) {
        if (!$(e.target).hasClass('page-size-item') && 
            !$(e.target).parent().hasClass('page-size-item')) {
            e.stopPropagation();
        }
    });
    
    // Submit form when filter button clicked
    $('.filter-submit-btn').on('click', function() {
        updateFilterCounters();
        // Close the dropdown
        $(this).closest('.dropdown-menu').prev('.dropdown-toggle').dropdown('toggle');
        // Submit the form
        $('#filterForm').submit();
    });
    
    // Update filter checkbox handling
    $('.filter-checkbox').on('change', function() {
        updateFilterCounters();
    });
    
    // Initialize filter counters
    updateFilterCounters();
});
</script>
{% endblock %}